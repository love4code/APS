<%- include('../partials/header', { title: 'Stores' }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Stores</h1>
    <a href="/stores/new" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> New Store
    </a>
  </div>

  <% if (stores && stores.length > 0) { %>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Address</th>
            <th>City</th>
            <th>State</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% stores.forEach(store => { %>
            <tr>
              <td><strong><%= store.name %></strong></td>
              <td><%= store.address || '-' %></td>
              <td><%= store.city || '-' %></td>
              <td><%= store.state || '-' %></td>
              <td><%= store.phone || '-' %></td>
              <td><%= store.email || '-' %></td>
              <td>
                <span class="badge bg-<%= store.isActive ? 'success' : 'secondary' %>">
                  <%= store.isActive ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="/stores/<%= store._id %>/edit" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                  </a>
                  <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#shareModal<%= store._id %>" title="Share Calendar">
                    <i class="bi bi-share"></i> Share
                  </button>
                  <form action="/stores/<%= store._id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this store?');">
                    <button type="submit" class="btn btn-outline-danger">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </form>
                </div>
                
                <!-- Share Modal -->
                <div class="modal fade" id="shareModal<%= store._id %>" tabindex="-1" aria-labelledby="shareModalLabel<%= store._id %>" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="shareModalLabel<%= store._id %>">Share Calendar - <%= store.name %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p>Share this calendar link with <strong><%= store.name %></strong>:</p>
                        <div class="input-group mb-3">
                          <input type="text" class="form-control" id="shareLink<%= store._id %>" value="<%= baseUrl %>/jobs/calendar/shared?type=store&token=<%= store.calendarShareToken || 'generating...' %>" readonly>
                          <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('shareLink<%= store._id %>', this)">
                            <i class="bi bi-clipboard"></i> Copy
                          </button>
                        </div>
                        <small class="text-muted">Anyone with this link can view the calendar for jobs assigned to <%= store.name %>.</small>
                        <hr>
                        <form action="/stores/<%= store._id %>/regenerate-token" method="POST" onsubmit="return confirm('Regenerating the token will invalidate the current share link. Continue?');">
                          <button type="submit" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> Regenerate Link
                          </button>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="alert alert-info">
      <p class="mb-0">No stores found. <a href="/stores/new">Create your first store</a></p>
    </div>
  <% } %>
</div>

<script>
  function copyToClipboard(inputId, button) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    
    // Update button text temporarily
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> Copied!';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('btn-success');
      button.classList.add('btn-outline-secondary');
    }, 2000);
  }
</script>

<%- include('../partials/footer') %>

