<%- include('../partials/header', { title: 'Sales Rep: ' + (salesRep.name || 'Unknown') }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Sales Rep: <%= salesRep.name %></h1>
    <div>
      <% if (salesRep && salesRep._id) { %>
      <a
        href="/admin/users/<%= salesRep._id.toString() %>/edit"
        class="btn btn-outline-secondary"
      >
        <i class="bi bi-pencil"></i> Edit User
      </a>
      <% } %>
      <a href="/sales-reps" class="btn btn-secondary">Back to Sales Reps</a>
    </div>
  </div>

  <div class="row">
    <!-- Stats Column -->
    <div class="col-md-4 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Sales Statistics</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Total Jobs:</span>
              <strong class="text-primary"><%= stats.totalJobs %></strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Total Sales:</span>
              <strong class="text-success"
                >$<%= stats.totalSales.toFixed(2) %></strong
              >
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Paid Sales:</span>
              <strong class="text-success"
                >$<%= stats.paidSales.toFixed(2) %></strong
              >
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Unpaid Sales:</span>
              <strong class="text-warning"
                >$<%= stats.unpaidSales.toFixed(2) %></strong
              >
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Average Sale:</span>
              <strong>$<%= stats.averageSale.toFixed(2) %></strong>
            </div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Total Payments:</span>
              <strong class="text-primary"
                >$<%= (stats.totalPayments || 0).toFixed(2) %></strong
              >
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Payment Count:</span>
              <span class="badge bg-info"><%= stats.paymentCount || 0 %></span>
            </div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Completed Jobs:</span>
              <span class="badge bg-success"><%= stats.completedJobs %></span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Scheduled Jobs:</span>
              <span class="badge bg-info"><%= stats.scheduledJobs %></span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span>Delivered Jobs:</span>
              <span class="badge bg-primary"><%= stats.deliveredJobs %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">
          <h5 class="mb-0">Contact Information</h5>
        </div>
        <div class="card-body">
          <p><strong>Email:</strong> <%= salesRep.email %></p>
          <p>
            <strong>Status:</strong>
            <span
              class="badge bg-<%= salesRep.isActive ? 'success' : 'danger' %>"
            >
              <%= salesRep.isActive ? 'Active' : 'Inactive' %>
            </span>
          </p>
          <hr>
          <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#shareCalendarModal">
            <i class="bi bi-share"></i> Share Calendar (All Jobs)
          </button>
          <form action="/sales-reps/<%= salesRep._id %>/regenerate-token" method="POST" onsubmit="return confirm('Regenerating the token will invalidate the current share link. Continue?');">
            <button type="submit" class="btn btn-outline-warning btn-sm w-100">
              <i class="bi bi-arrow-clockwise"></i> Regenerate Link
            </button>
          </form>
        </div>
      </div>
      
      <!-- Share Calendar Modal -->
      <div class="modal fade" id="shareCalendarModal" tabindex="-1" aria-labelledby="shareCalendarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="shareCalendarModalLabel">Share Calendar - <%= salesRep.name %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <ul class="nav nav-tabs mb-3" id="shareTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="link-tab" data-bs-toggle="tab" data-bs-target="#link-pane" type="button" role="tab">
                    <i class="bi bi-link-45deg"></i> Share Link
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="invite-tab" data-bs-toggle="tab" data-bs-target="#invite-pane" type="button" role="tab">
                    <i class="bi bi-envelope"></i> Send Invite
                  </button>
                </li>
              </ul>
              <div class="tab-content" id="shareTabContent">
                <div class="tab-pane fade show active" id="link-pane" role="tabpanel">
                  <p>Share this calendar link with <strong><%= salesRep.name %></strong>:</p>
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This calendar shows <strong>all jobs</strong> across all stores.
                  </div>
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" id="salesRepShareLink" value="<%= baseUrl %>/jobs/calendar/shared?type=salesrep&token=<%= salesRep.calendarShareToken || 'generating...' %>" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('salesRepShareLink', this)">
                      <i class="bi bi-clipboard"></i> Copy
                    </button>
                  </div>
                  <small class="text-muted">Anyone with this link can view the calendar for all jobs across all stores.</small>
                </div>
                <div class="tab-pane fade" id="invite-pane" role="tabpanel">
                  <p>Send a calendar invite that requires login credentials:</p>
                  <form action="/sales-reps/<%= salesRep._id %>/send-invite" method="POST">
                    <div class="mb-3">
                      <label for="inviteEmail" class="form-label">Email Address *</label>
                      <input type="email" class="form-control" id="inviteEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                      <label for="inviteName" class="form-label">Name (optional)</label>
                      <input type="text" class="form-control" id="inviteName" name="name">
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-send"></i> Send Invite
                    </button>
                  </form>
                  <small class="text-muted d-block mt-2">The recipient will receive an email with a link to create an account and view the calendar.</small>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales and Jobs Column -->
    <div class="col-md-8">
      <!-- Sales Section -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">All Sales (<%= typeof sales !== 'undefined' ? sales.length : 0 %>)</h5>
        </div>
        <div class="card-body">
          <% if (typeof sales !== 'undefined' && sales && sales.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Installer</th>
                  <th>Total</th>
                  <th>Paid</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% sales.forEach(sale => { %>
                <tr>
                  <td>
                    <a href="/customers/<%= sale.customer._id %>">
                      <%= sale.customer.name %>
                    </a>
                  </td>
                  <td><%= new Date(sale.createdAt).toLocaleDateString() %></td>
                  <td>
                    <span
                      class="badge bg-<%= sale.status === 'complete' ? 'success' : sale.status === 'delayed' ? 'warning' : sale.status === 'delivered' ? 'info' : 'secondary' %>"
                    >
                      <%= sale.status %>
                    </span>
                  </td>
                  <td>
                    <%= sale.installer ? sale.installer.name : 'Not assigned' %>
                  </td>
                  <td>
                    <strong>$<%= (sale.totalPrice || 0).toFixed(2) %></strong>
                  </td>
                  <td>
                    <span
                      class="badge bg-<%= sale.isPaid ? 'success' : 'danger' %>"
                    >
                      <%= sale.isPaid ? 'Paid' : 'Unpaid' %>
                    </span>
                  </td>
                  <td>
                    <a
                      href="/jobs/<%= sale._id %>"
                      class="btn btn-sm btn-outline-primary"
                    >
                      View
                    </a>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <% } else { %>
          <p class="text-muted">No sales found for this sales rep.</p>
          <% } %>
        </div>
      </div>

      <!-- Jobs Section -->
      <% if (typeof jobs !== 'undefined' && jobs && jobs.length > 0) { %>
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">All Jobs (<%= jobs.length %>)</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Installer</th>
                  <th>Total</th>
                  <th>Paid</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% jobs.forEach(job => { %>
                <tr>
                  <td>
                    <a href="/customers/<%= job.customer._id %>">
                      <%= job.customer.name %>
                    </a>
                  </td>
                  <td><%= new Date(job.createdAt).toLocaleDateString() %></td>
                  <td>
                    <span
                      class="badge bg-<%= job.status === 'complete' ? 'success' : job.status === 'delayed' ? 'warning' : job.status === 'delivered' ? 'info' : 'secondary' %>"
                    >
                      <%= job.status %>
                    </span>
                  </td>
                  <td>
                    <%= job.installer ? job.installer.name : 'Not assigned' %>
                  </td>
                  <td>
                    <strong>$<%= (job.totalPrice || 0).toFixed(2) %></strong>
                  </td>
                  <td>
                    <span
                      class="badge bg-<%= job.isPaid ? 'success' : 'danger' %>"
                    >
                      <%= job.isPaid ? 'Paid' : 'Unpaid' %>
                    </span>
                  </td>
                  <td>
                    <a
                      href="/jobs/<%= job._id %>"
                      class="btn btn-sm btn-outline-primary"
                    >
                      View
                    </a>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Payments Section -->
      <div class="card mt-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Payments (<%= payments ? payments.length : 0 %>)</h5>
          <a
            href="/payments/new?recipientId=<%= salesRep._id %>&recipientType=salesRep"
            class="btn btn-sm btn-primary"
          >
            <i class="bi bi-plus-circle"></i> Record Payment
          </a>
        </div>
        <div class="card-body">
          <% if (payments && payments.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Jobs</th>
                  <th>Customers</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% payments.forEach(payment => { 
                  // Get jobs from jobs array, or fall back to single job for backward compatibility
                  let displayJobs = [];
                  if (payment.jobs && payment.jobs.length > 0) {
                    displayJobs = payment.jobs;
                  } else if (payment.job) {
                    displayJobs = [payment.job];
                  }
                %>
                <tr>
                  <td>
                    <%= new Date(payment.datePaid).toLocaleDateString() %>
                  </td>
                  <td>
                    <% if (displayJobs.length > 0) { %>
                      <% displayJobs.forEach((job, index) => { %>
                        <a href="/jobs/<%= job._id %>">
                          Job #<%= job._id.toString().slice(-6) %>
                        </a>
                        <% if (index < displayJobs.length - 1) { %>, <% } %>
                      <% }) %>
                    <% } else { %>
                      N/A
                    <% } %>
                  </td>
                  <td>
                    <% if (displayJobs.length > 0) { %>
                      <% displayJobs.forEach((job, index) => { %>
                        <% if (job.customer) { %>
                          <a href="/customers/<%= job.customer._id %>">
                            <%= job.customer.name %>
                          </a>
                        <% } else { %>N/A<% } %>
                        <% if (index < displayJobs.length - 1) { %>, <% } %>
                      <% }) %>
                    <% } else { %>
                      N/A
                    <% } %>
                  </td>
                  <td><strong>$<%= payment.amount.toFixed(2) %></strong></td>
                  <td>
                    <span class="badge bg-secondary"><%= payment.paymentMethod.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></span>
                  </td>
                  <td>
                    <a
                      href="/payments/<%= payment._id %>"
                      class="btn btn-sm btn-outline-primary"
                      >View</a
                    >
                  </td>
                </tr>
                <% }) %>
              </tbody>
              <tfoot>
                <tr class="table-primary">
                  <td colspan="3"><strong>Total:</strong></td>
                  <td>
                    <strong
                      >$<%= (stats.totalPayments || 0).toFixed(2) %></strong
                    >
                  </td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <% } else { %>
          <p class="text-muted">No payments recorded for this sales rep.</p>
          <a
            href="/payments/new?recipientId=<%= salesRep._id %>&recipientType=salesRep"
            class="btn btn-sm btn-primary"
          >
            <i class="bi bi-plus-circle"></i> Record First Payment
          </a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function copyToClipboard(inputId, button) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    
    // Update button text temporarily
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> Copied!';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('btn-success');
      button.classList.add('btn-outline-secondary');
    }, 2000);
  }
</script>

<%- include('../partials/footer') %>
