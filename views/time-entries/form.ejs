<%- include('../partials/header', { title: timeEntry ? 'Edit Time Entry' : 'New Time Entry' }) %>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h1 class="h3 mb-4"><%= timeEntry ? 'Edit Time Entry' : 'New Time Entry' %></h1>

      <form method="POST" action="<%= timeEntry ? `/time-entries/${timeEntry._id}` : '/time-entries' %>" id="timeEntryForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="employee" class="form-label">Employee *</label>
            <select class="form-select" id="employee" name="employee" required>
              <option value="">Select employee...</option>
              <% if (employees && employees.length > 0) { %>
                <% employees.forEach(emp => { %>
                  <option value="<%= emp._id %>" <%= (timeEntry && timeEntry.employee && timeEntry.employee._id.toString() === emp._id.toString()) || (selectedEmployeeId && selectedEmployeeId.toString() === emp._id.toString()) ? 'selected' : '' %>>
                    <%= emp.firstName %> <%= emp.lastName %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="date" class="form-label">Date *</label>
            <input type="date" class="form-control" id="date" name="date" value="<%= timeEntry && timeEntry.date ? new Date(timeEntry.date).toISOString().split('T')[0] : '' %>" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="startTime" class="form-label">Start Time</label>
            <input type="time" class="form-control" id="startTime" name="startTime" value="<%= timeEntry && timeEntry.startTime ? (() => { const d = new Date(timeEntry.startTime); const hours = d.getHours().toString().padStart(2, '0'); const minutes = d.getMinutes().toString().padStart(2, '0'); return hours + ':' + minutes; })() : '' %>" onchange="calculateHours()">
            <small class="form-text text-muted">Optional: Leave blank to enter hours directly</small>
          </div>
          <div class="col-md-6 mb-3">
            <label for="endTime" class="form-label">End Time</label>
            <input type="time" class="form-control" id="endTime" name="endTime" value="<%= timeEntry && timeEntry.endTime ? (() => { const d = new Date(timeEntry.endTime); const hours = d.getHours().toString().padStart(2, '0'); const minutes = d.getMinutes().toString().padStart(2, '0'); return hours + ':' + minutes; })() : '' %>" onchange="calculateHours()">
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="hoursWorked" class="form-label">Hours Worked *</label>
            <input type="number" class="form-control" id="hoursWorked" name="hoursWorked" step="0.25" min="0" value="<%= timeEntry ? (timeEntry.hoursWorked || 0) : '' %>" required onchange="calculateOvertime()">
          </div>
          <div class="col-md-4 mb-3">
            <label for="breakMinutes" class="form-label">Break Minutes</label>
            <input type="number" class="form-control" id="breakMinutes" name="breakMinutes" min="0" value="<%= timeEntry ? (timeEntry.breakMinutes || 0) : '0' %>" onchange="calculateHours()">
          </div>
          <div class="col-md-4 mb-3">
            <label for="overtimeHours" class="form-label">Overtime Hours</label>
            <input type="number" class="form-control" id="overtimeHours" name="overtimeHours" step="0.25" min="0" value="<%= timeEntry ? (timeEntry.overtimeHours || 0) : '0' %>">
            <small class="form-text text-muted">Auto-calculated if > 8 hours</small>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="type" class="form-label">Type *</label>
            <select class="form-select" id="type" name="type" required onchange="calculateOvertime()">
              <option value="regular" <%= timeEntry && timeEntry.type === 'regular' ? 'selected' : '' %>>Regular</option>
              <option value="overtime" <%= timeEntry && timeEntry.type === 'overtime' ? 'selected' : '' %>>Overtime</option>
              <option value="pto" <%= timeEntry && timeEntry.type === 'pto' ? 'selected' : '' %>>PTO</option>
              <option value="sick" <%= timeEntry && timeEntry.type === 'sick' ? 'selected' : '' %>>Sick</option>
              <option value="holiday" <%= timeEntry && timeEntry.type === 'holiday' ? 'selected' : '' %>>Holiday</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Jobs/Projects</label>
          <div id="jobs-container" class="mb-2">
            <% if (timeEntry && timeEntry.jobs && timeEntry.jobs.length > 0) { %>
              <% timeEntry.jobs.forEach((job, index) => { %>
                <div class="job-row card mb-2 p-2" data-index="<%= index %>">
                  <div class="row align-items-center">
                    <div class="col-md-5">
                      <div class="job-search-wrapper" data-index="<%= index %>">
                        <div class="input-group">
                          <input type="text" class="form-control job-search-input" placeholder="Search jobs..." autocomplete="off" value="<%= job.jobName || '' %>" data-selected-id="<%= job.job ? job.job.toString() : job.jobId || '' %>">
                          <input type="hidden" class="job-id-input" name="jobs[<%= index %>][jobId]" value="<%= job.job ? job.job.toString() : job.jobId || '' %>">
                          <input type="hidden" class="job-name-input" name="jobs[<%= index %>][jobName]" value="<%= job.jobName || '' %>">
                          <div class="job-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; z-index: 10000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control job-id-display" value="<%= job.jobId || (job.job ? job.job.toString() : '') %>" readonly placeholder="Job ID (auto-filled)">
                    </div>
                    <div class="col-md-3">
                      <button type="button" class="btn btn-sm btn-danger remove-job" onclick="removeJobRow(this)">
                        <i class="bi bi-x"></i> Remove
                      </button>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="job-row card mb-2 p-2" data-index="0">
                <div class="row align-items-center">
                  <div class="col-md-5">
                    <div class="job-search-wrapper" data-index="0">
                      <div class="input-group">
                        <input type="text" class="form-control job-search-input" placeholder="Search jobs..." autocomplete="off">
                        <input type="hidden" class="job-id-input" name="jobs[0][jobId]">
                        <input type="hidden" class="job-name-input" name="jobs[0][jobName]">
                        <div class="job-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; z-index: 10000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <input type="text" class="form-control job-id-display" readonly placeholder="Job ID (auto-filled)">
                  </div>
                  <div class="col-md-3">
                    <button type="button" class="btn btn-sm btn-danger remove-job" onclick="removeJobRow(this)">
                      <i class="bi bi-x"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addJobRow()">
            <i class="bi bi-plus"></i> Add Job
          </button>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"><%= timeEntry ? (timeEntry.notes || '') : '' %></textarea>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save Time Entry</button>
          <a href="<%= timeEntry ? `/time-entries/${timeEntry._id}` : '/time-entries' %>" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function calculateHours() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const breakMinutes = parseFloat(document.getElementById('breakMinutes').value) || 0;
    
    if (startTime && endTime) {
      const [startHour, startMin] = startTime.split(':').map(Number);
      const [endHour, endMin] = endTime.split(':').map(Number);
      
      let startTotal = startHour * 60 + startMin;
      let endTotal = endHour * 60 + endMin;
      
      // Handle next day
      if (endTotal < startTotal) {
        endTotal += 24 * 60;
      }
      
      const diffMinutes = endTotal - startTotal - breakMinutes;
      const diffHours = Math.max(0, diffMinutes / 60);
      
      document.getElementById('hoursWorked').value = diffHours.toFixed(2);
      calculateOvertime();
    }
  }
  
  function calculateOvertime() {
    const hoursWorked = parseFloat(document.getElementById('hoursWorked').value) || 0;
    const type = document.getElementById('type').value;
    
    if (type === 'regular' && hoursWorked > 8) {
      const overtime = hoursWorked - 8;
      document.getElementById('overtimeHours').value = overtime.toFixed(2);
    } else if (type !== 'regular') {
      document.getElementById('overtimeHours').value = '0';
    }
  }

  // Job search functionality
  let jobs = <%- JSON.stringify(jobs || []) %>;
  let jobIndex = <%= timeEntry && timeEntry.jobs ? timeEntry.jobs.length : 1 %>;

  function initJobSearch(wrapper, searchInput, jobIdInput, jobNameInput, jobIdDisplay, dropdown) {
    let selectedJob = null;
    let isMouseOverDropdown = false;
    let isMouseOverWrapper = false;

    function filterJobs() {
      if (!searchInput || !dropdown || !jobs) {
        return;
      }
      
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      // Filter jobs based on search term
      const filtered = jobs.filter(j => {
        const customerName = j.customer ? j.customer.name.toLowerCase() : '';
        const jobId = j._id.toString().toLowerCase();
        const installDate = j.installDate ? new Date(j.installDate).toLocaleDateString().toLowerCase() : '';
        const status = (j.status || '').toLowerCase();
        
        return searchTerm.length === 0 || 
               customerName.includes(searchTerm) ||
               jobId.includes(searchTerm) ||
               installDate.includes(searchTerm) ||
               status.includes(searchTerm);
      });
      
      // Show dropdown if there are results
      if (filtered.length > 0 && searchTerm.length > 0) {
        dropdown.style.display = 'block';
        dropdown.innerHTML = filtered.map(j => {
          const customerName = j.customer ? j.customer.name : 'Unknown';
          const jobId = j._id.toString();
          const installDate = j.installDate ? new Date(j.installDate).toLocaleDateString() : 'N/A';
          const status = j.status || 'N/A';
          return `<div class="job-option p-2 border-bottom" style="cursor: pointer;" data-id="${j._id}" data-name="${customerName} - Job #${jobId}">
            <div>
              <strong>${customerName}</strong>
              <div class="text-muted small">Job #${jobId} | Install: ${installDate} | Status: ${status}</div>
            </div>
          </div>`;
        }).join('');
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    // Search input event
    searchInput.addEventListener('input', filterJobs);
    
    // Show suggestions on focus
    searchInput.addEventListener('focus', function() {
      filterJobs();
    });

    // Mouse tracking
    wrapper.addEventListener('mouseenter', function() {
      isMouseOverWrapper = true;
    });
    wrapper.addEventListener('mouseleave', function() {
      isMouseOverWrapper = false;
      if (!isMouseOverDropdown) {
        setTimeout(() => {
          if (!isMouseOverDropdown && !isMouseOverWrapper) {
            dropdown.style.display = 'none';
          }
        }, 200);
      }
    });

    dropdown.addEventListener('mouseenter', function() {
      isMouseOverDropdown = true;
    });
    dropdown.addEventListener('mouseleave', function() {
      isMouseOverDropdown = false;
      setTimeout(() => {
        if (!isMouseOverDropdown && !isMouseOverWrapper) {
          dropdown.style.display = 'none';
        }
      }, 200);
    });
    
    // Handle job selection
    dropdown.addEventListener('click', function(e) {
      const option = e.target.closest('.job-option');
      if (option) {
        e.stopPropagation();
        const jobId = option.getAttribute('data-id');
        const jobName = option.getAttribute('data-name');
        const job = jobs.find(j => j._id.toString() === jobId);
        
        if (job) {
          selectedJob = job;
          searchInput.value = jobName;
          jobIdInput.value = jobId;
          jobNameInput.value = jobName;
          jobIdDisplay.value = jobId;
          dropdown.style.display = 'none';
        }
      }
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
      if (!wrapper.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  }

  function addJobRow() {
    const container = document.getElementById('jobs-container');
    
    const jobRow = document.createElement('div');
    jobRow.className = 'job-row card mb-2 p-2';
    jobRow.setAttribute('data-index', jobIndex);
    
    jobRow.innerHTML = 
      '<div class="row align-items-center">' +
        '<div class="col-md-5">' +
          '<div class="job-search-wrapper" data-index="' + jobIndex + '">' +
            '<div class="input-group" style="position: relative;">' +
              '<input type="text" class="form-control job-search-input" placeholder="Search jobs..." autocomplete="off">' +
              '<input type="hidden" class="job-id-input" name="jobs[' + jobIndex + '][jobId]">' +
              '<input type="hidden" class="job-name-input" name="jobs[' + jobIndex + '][jobName]">' +
              '<div class="job-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; z-index: 10000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;"></div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="col-md-4">' +
          '<input type="text" class="form-control job-id-display" readonly placeholder="Job ID (auto-filled)">' +
        '</div>' +
        '<div class="col-md-3">' +
          '<button type="button" class="btn btn-sm btn-danger remove-job" onclick="removeJobRow(this)">' +
            '<i class="bi bi-x"></i> Remove' +
          '</button>' +
        '</div>' +
      '</div>';
    
    container.appendChild(jobRow);
    
    // Initialize search for new row
    const wrapper = jobRow.querySelector('.job-search-wrapper');
    const searchInput = jobRow.querySelector('.job-search-input');
    const jobIdInput = jobRow.querySelector('.job-id-input');
    const jobNameInput = jobRow.querySelector('.job-name-input');
    const jobIdDisplay = jobRow.querySelector('.job-id-display');
    const dropdown = jobRow.querySelector('.job-dropdown');
    
    initJobSearch(wrapper, searchInput, jobIdInput, jobNameInput, jobIdDisplay, dropdown);
    
    // Focus on search input
    setTimeout(() => {
      searchInput.focus();
    }, 100);
    
    jobIndex++;
  }

  function removeJobRow(button) {
    const container = document.getElementById('jobs-container');
    const jobRow = button.closest('.job-row');
    if (container.children.length > 1) {
      jobRow.remove();
    } else {
      // Clear the last row instead of removing it
      jobRow.querySelector('.job-search-input').value = '';
      jobRow.querySelector('.job-id-input').value = '';
      jobRow.querySelector('.job-name-input').value = '';
      jobRow.querySelector('.job-id-display').value = '';
    }
  }

  // Initialize job search for existing rows
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.job-search-wrapper').forEach(wrapper => {
      const searchInput = wrapper.querySelector('.job-search-input');
      const jobIdInput = wrapper.querySelector('.job-id-input');
      const jobNameInput = wrapper.querySelector('.job-name-input');
      const jobIdDisplay = wrapper.querySelector('.job-id-display');
      const dropdown = wrapper.querySelector('.job-dropdown');
      
      initJobSearch(wrapper, searchInput, jobIdInput, jobNameInput, jobIdDisplay, dropdown);
    });
  });
</script>

<style>
  .job-search-wrapper {
    position: relative;
  }
  
  .job-dropdown {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .job-option:hover {
    background-color: #f8f9fa;
  }
</style>

<%- include('../partials/footer') %>

