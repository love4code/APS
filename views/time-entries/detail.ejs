<%- include('../partials/header', { title: 'Time Entry Details' }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Time Entry Details</h1>
    <div class="d-flex gap-2">
      <% if (!timeEntry.approved) { %>
        <a href="/time-entries/<%= timeEntry._id %>/edit" class="btn btn-outline-primary">Edit</a>
        <% if (user && user.role === 'admin') { %>
          <form action="/time-entries/<%= timeEntry._id %>/approve" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success">Approve</button>
          </form>
        <% } %>
      <% } %>
      <form action="/time-entries/<%= timeEntry._id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this time entry? This action cannot be undone.');">
        <button type="submit" class="btn btn-outline-danger">Delete</button>
      </form>
      <a href="/time-entries" class="btn btn-outline-secondary">Back to Time Entries</a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Time Entry Information</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Employee:</strong> 
                <% if (timeEntry.employee) { %>
                  <a href="/employees/<%= timeEntry.employee._id %>">
                    <%= timeEntry.employee.firstName %> <%= timeEntry.employee.lastName %>
                  </a>
                <% } else { %>
                  Unknown
                <% } %>
              </p>
              <p><strong>Date:</strong> <%= timeEntry.date ? (() => { const d = new Date(timeEntry.date); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() : '-' %></p>
              <% if (timeEntry.startTime && timeEntry.endTime) { %>
                <p><strong>Time:</strong> 
                  <%= new Date(timeEntry.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %> - 
                  <%= new Date(timeEntry.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                </p>
              <% } %>
              <p><strong>Hours Worked:</strong> <%= (timeEntry.hoursWorked || 0).toFixed(2) %></p>
              <p><strong>Break Minutes:</strong> <%= timeEntry.breakMinutes || 0 %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Overtime Hours:</strong> <%= (timeEntry.overtimeHours || 0).toFixed(2) %></p>
              <p><strong>Type:</strong> 
                <span class="badge bg-<%= timeEntry.type === 'pto' || timeEntry.type === 'sick' ? 'info' : timeEntry.type === 'holiday' ? 'warning' : 'primary' %>">
                  <%= timeEntry.type %>
                </span>
              </p>
              <p><strong>Status:</strong> 
                <span class="badge bg-<%= timeEntry.approved ? 'success' : 'warning' %>">
                  <%= timeEntry.approved ? 'Approved' : 'Pending Approval' %>
                </span>
              </p>
              <% if (timeEntry.approved && timeEntry.approvedBy) { %>
                <p><strong>Approved By:</strong> <%= timeEntry.approvedBy.name %></p>
              <% } %>
            </div>
          </div>
          
          <!-- Pay Calculation Section -->
          <% if (typeof amountOwed !== 'undefined' && payCalculation) { %>
            <div class="mt-4 border-top pt-3">
              <h6 class="mb-3">Pay Calculation</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Pay Type:</strong> <%= payCalculation.payType %></p>
                  <% if (payCalculation.rate > 0) { %>
                    <p><strong>Rate:</strong> 
                      <% if (payCalculation.payType === 'Hourly') { %>
                        $<%= payCalculation.rate.toFixed(2) %>/hr
                      <% } else if (payCalculation.payType === 'Salary') { %>
                        $<%= payCalculation.rate.toFixed(2) %>/day
                      <% } else { %>
                        <%= payCalculation.rate.toFixed(2) %>%
                      <% } %>
                    </p>
                  <% } %>
                  <p><strong>Regular Hours:</strong> <%= payCalculation.regularHours.toFixed(2) %></p>
                  <% if (payCalculation.overtimeHours > 0) { %>
                    <p><strong>Overtime Hours:</strong> <%= payCalculation.overtimeHours.toFixed(2) %></p>
                  <% } %>
                </div>
                <div class="col-md-6">
                  <% if (payCalculation.regularPay > 0) { %>
                    <p><strong>Regular Pay:</strong> $<%= payCalculation.regularPay.toFixed(2) %></p>
                  <% } %>
                  <% if (payCalculation.overtimePay > 0) { %>
                    <p><strong>Overtime Pay:</strong> $<%= payCalculation.overtimePay.toFixed(2) %></p>
                  <% } %>
                  <p class="h5 mt-3">
                    <strong>Total Amount Owed:</strong> 
                    <span class="text-success">$<%= amountOwed.toFixed(2) %></span>
                  </p>
                  <% if (payCalculation.payType === 'Percentage') { %>
                    <p class="text-muted small">Note: Percentage pay is calculated based on profit, not hours worked.</p>
                  <% } %>
                </div>
              </div>
            </div>
          <% } %>
          <% if (timeEntry.jobs && timeEntry.jobs.length > 0) { %>
            <div class="mt-3">
              <strong>Jobs/Projects:</strong>
              <ul class="list-unstyled mt-2">
                <% timeEntry.jobs.forEach(job => { %>
                  <li class="mb-2">
                    <% if (job.job && typeof job.job === 'object') { %>
                      <a href="/jobs/<%= job.job._id %>">
                        <%= job.job.customer ? job.job.customer.name : 'Unknown' %> - Job #<%= job.job._id %>
                      </a>
                      <% if (job.job.installDate) { %>
                        <span class="text-muted">(Install: <%= (() => { const d = new Date(job.job.installDate); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() %>)</span>
                      <% } %>
                    <% } else { %>
                      <%= job.jobName || job.jobId || 'N/A' %>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% } else if (timeEntry.jobName) { %>
            <div class="mt-3">
              <strong>Job/Project:</strong> <%= timeEntry.jobName %>
            </div>
          <% } %>
          <% if (timeEntry.notes) { %>
            <div class="mt-3">
              <strong>Notes:</strong>
              <p class="text-muted"><%= timeEntry.notes %></p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

