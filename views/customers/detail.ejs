<%- include('../partials/header', { title: customer.name }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3"><%= customer.name %></h1>
    <div class="d-flex gap-2">
      <a href="/jobs/new?customerId=<%= customer._id %>" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> New Job
      </a>
      <a href="/sales/new?customerId=<%= customer._id %>" class="btn btn-success">
        <i class="bi bi-cart-plus"></i> New Sale
      </a>
      <a href="/invoices/new?customerId=<%= customer._id %>" class="btn btn-outline-primary">
        <i class="bi bi-receipt"></i> Create Invoice
      </a>
      <a
        href="/customers/<%= customer._id %>/edit"
        class="btn btn-outline-secondary"
        >Edit</a
      >
      <form
        action="/customers/<%= customer._id %>/delete"
        method="POST"
        class="d-inline"
        onsubmit="return confirm('Delete this customer? This will fail if customer has jobs.')"
      >
        <button type="submit" class="btn btn-outline-danger">Delete</button>
      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Contact Information</h5>
          <p><strong>Phone:</strong> <%= customer.phone || 'N/A' %></p>
          <p><strong>Email:</strong> <%= customer.email || 'N/A' %></p>
          <p><strong>Address:</strong> <%= customer.address || 'N/A' %></p>
          <% if (customer.notes) { %>
          <div class="mt-3">
            <strong>Notes:</strong>
            <p class="text-muted"><%= customer.notes %></p>
          </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <!-- Sales Section -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
          <h5 class="mb-0">Sales (<%= sales ? sales.length : 0 %>)</h5>
          <div>
            <a href="/sales/new?customerId=<%= customer._id %>" class="btn btn-sm btn-light">
              <i class="bi bi-cart-plus"></i> New Sale
            </a>
          </div>
        </div>
        <div class="card-body">
          <% if (sales && sales.length > 0) { %>
          <div class="list-group">
            <% sales.forEach(sale => { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <a href="/jobs/<%= sale._id %>" class="text-decoration-none">
                    <strong>Sale #<%= sale._id.toString().slice(-6) %></strong>
                  </a>
                  <span
                    class="badge bg-<%= sale.status === 'complete' ? 'success' : sale.status === 'delayed' ? 'warning' : sale.status === 'delivered' ? 'info' : 'secondary' %> ms-2"
                  >
                    <%= sale.status %>
                  </span>
                </div>
                <div class="text-end">
                  <div>$<%= (sale.totalPrice || 0).toFixed(2) %></div>
                  <small class="text-muted"
                    ><%= new Date(sale.createdAt).toLocaleDateString() %></small
                  >
                </div>
              </div>
              <div class="mt-2">
                <a href="/invoices/new?jobId=<%= sale._id %>" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-receipt"></i> Invoice
                </a>
                <a href="/jobs/<%= sale._id %>" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-eye"></i> View
                </a>
              </div>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <p class="text-muted">No sales for this customer</p>
          <% } %>
        </div>
      </div>

      <!-- Jobs Section -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Jobs (<%= jobs ? jobs.length : 0 %>)</h5>
          <div>
            <a href="/jobs/new?customerId=<%= customer._id %>" class="btn btn-sm btn-primary">
              <i class="bi bi-plus-circle"></i> New Job
            </a>
          </div>
        </div>
        <div class="card-body">
          <% if (jobs && jobs.length > 0) { %>
          <div class="list-group">
            <% jobs.forEach(job => { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <a href="/jobs/<%= job._id %>" class="text-decoration-none">
                    <strong>Job #<%= job._id.toString().slice(-6) %></strong>
                  </a>
                  <span
                    class="badge bg-<%= job.status === 'complete' ? 'success' : job.status === 'delayed' ? 'warning' : job.status === 'delivered' ? 'info' : 'secondary' %> ms-2"
                  >
                    <%= job.status %>
                  </span>
                </div>
                <div class="text-end">
                  <div>$<%= (job.totalPrice || 0).toFixed(2) %></div>
                  <small class="text-muted"
                    ><%= new Date(job.createdAt).toLocaleDateString() %></small
                  >
                </div>
              </div>
              <div class="mt-2">
                <a href="/invoices/new?jobId=<%= job._id %>" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-receipt"></i> Invoice
                </a>
                <a href="/jobs/<%= job._id %>" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-eye"></i> View
                </a>
              </div>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <p class="text-muted">No jobs for this customer</p>
          <% } %>
        </div>
      </div>

      <% if (invoices && invoices.length > 0) { %>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Invoices (<%= invoices.length %>)</h5>
          <a href="/invoices/new?customerId=<%= customer._id %>" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> New Invoice
          </a>
        </div>
        <div class="card-body">
          <div class="list-group">
            <% invoices.forEach(invoice => { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <a href="/invoices/<%= invoice._id %>" class="text-decoration-none">
                    <strong><%= invoice.invoiceNumber %></strong>
                  </a>
                  <% 
                    let statusClass = 'secondary'
                    if (invoice.status === 'paid') statusClass = 'success'
                    else if (invoice.status === 'sent') statusClass = 'info'
                    else if (invoice.status === 'overdue') statusClass = 'danger'
                    else if (invoice.status === 'draft') statusClass = 'warning'
                  %>
                  <span class="badge bg-<%= statusClass %> ms-2"><%= invoice.status.toUpperCase() %></span>
                  <% if (invoice.job) { %>
                  <span class="badge bg-primary ms-1">Job #<%= invoice.job._id.toString().slice(-6) %></span>
                  <% } %>
                </div>
                <div class="text-end">
                  <div><strong>$<%= (invoice.totalPrice || 0).toFixed(2) %></strong></div>
                  <small class="text-muted"><%= new Date(invoice.issueDate).toLocaleDateString() %></small>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
          <div class="mt-2 text-center">
            <a href="/invoices?customerId=<%= customer._id %>" class="btn btn-sm btn-outline-secondary">
              View All Invoices
            </a>
          </div>
        </div>
      </div>
      <% } else { %>
      <div class="card">
        <div class="card-body text-center">
          <p class="text-muted mb-2">No invoices for this customer</p>
          <a href="/invoices/new?customerId=<%= customer._id %>" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Create First Invoice
          </a>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
