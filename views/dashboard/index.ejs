<%- include('../partials/header', { title: 'Dashboard' }) %>

<div class="container-fluid">
  <h1 class="h3 mb-4">Dashboard</h1>

  <!-- Installers Row -->
  <div class="mb-4">
    <h2 class="h5 mb-3">Installers</h2>
    <div
      class="d-flex flex-row flex-nowrap overflow-auto pb-3"
      style="gap: 1rem"
    >
      <% if (installers && installers.length > 0) { %> <% installers.forEach(installer => { %> <% if (installer && installer._id) { %>
      <div class="card" style="min-width: 250px">
        <div class="card-body">
          <h5 class="card-title">
            <a
              href="/installers/<%= installer._id.toString() %>"
              class="text-decoration-none"
            >
              <%= installer.name || 'Unknown' %>
            </a>
          </h5>
          <p class="card-text text-muted small">
            <%= installer.email || 'No email' %>
          </p>
          <div class="d-flex justify-content-between">
            <span class="badge bg-info"
              >Scheduled: <%= installer.scheduled || 0 %></span
            >
            <span class="badge bg-success"
              >Completed: <%= installer.completed || 0 %></span
            >
          </div>
          <div class="mt-2">
            <a
              href="/installers/<%= installer._id.toString() %>"
              class="btn btn-sm btn-outline-primary w-100"
            >
              View Details
            </a>
          </div>
        </div>
      </div>
      <% } %> <% }) %> <% } else { %>
      <div class="card" style="min-width: 250px">
        <div class="card-body text-muted">No installers found</div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Sales Reps Row -->
  <div class="mb-4">
    <h2 class="h5 mb-3">Sales Reps</h2>
    <div
      class="d-flex flex-row flex-nowrap overflow-auto pb-3"
      style="gap: 1rem"
    >
      <% if (salesReps && salesReps.length > 0) { %> <% salesReps.forEach(rep => { %> <% if (rep && rep._id) { %>
      <div class="card" style="min-width: 250px">
        <div class="card-body">
          <h5 class="card-title">
            <a
              href="/sales-reps/<%= rep._id.toString() %>"
              class="text-decoration-none"
            >
              <%= rep.name || 'Unknown' %>
            </a>
          </h5>
          <p class="card-text text-muted small">
            <%= rep.email || 'No email' %>
          </p>
          <div>
            <p class="mb-1">
              <strong>Total Jobs:</strong> <%= rep.totalJobs || 0 %>
            </p>
            <p class="mb-0">
              <strong>Sales Total:</strong> $<%= (rep.salesTotal || 0).toFixed(2) %>
            </p>
          </div>
          <div class="mt-2">
            <a
              href="/sales-reps/<%= rep._id.toString() %>"
              class="btn btn-sm btn-outline-primary w-100"
            >
              View Details
            </a>
          </div>
        </div>
      </div>
      <% } %> <% }) %> <% } else { %>
      <div class="card" style="min-width: 250px">
        <div class="card-body text-muted">No sales reps found</div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Pool Sales Row -->
  <div class="mb-4">
    <h2 class="h5 mb-3">Recent Pool Sales</h2>
    <div
      class="d-flex flex-row flex-nowrap overflow-auto pb-3"
      style="gap: 1rem"
    >
      <% if (poolSales && poolSales.length > 0) { %> <% poolSales.forEach(sale => { %> <% if (sale && sale._id) { %>
      <div class="card" style="min-width: 320px">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <% 
              let deliveryStatusClass = 'secondary';
              let deliveryStatusText = 'Not Ordered';
              if (sale.deliveryDate) {
                deliveryStatusClass = 'success';
                deliveryStatusText = 'Delivered';
              } else if (sale.orderDate) {
                deliveryStatusClass = 'warning';
                deliveryStatusText = 'Ordered';
              }
            %>
            <span class="badge bg-<%= deliveryStatusClass %>">
              <%= deliveryStatusText %>
            </span>
            <span class="badge bg-<%= sale.isPaid ? 'success' : 'danger' %>">
              <%= sale.isPaid ? 'Paid' : 'Unpaid' %>
            </span>
          </div>
          <h5 class="card-title">
            <%= sale.customer && sale.customer.name ? sale.customer.name : 'Unknown Customer' %>
          </h5>
          <p class="card-text small mb-1">
            <strong>Total:</strong> $<%= (sale.totalPrice || 0).toFixed(2) %>
          </p>
          <p class="card-text small mb-1">
            <strong>Sold by:</strong>
            <%= sale.soldByOwner ? 'Owner' : (sale.salesRep && sale.salesRep.name ? sale.salesRep.name : 'N/A') %>
          </p>
          <% if (sale.orderDate) { %>
          <p class="card-text small mb-1">
            <strong>Order Date:</strong> <%= new Date(sale.orderDate).toLocaleDateString() %>
          </p>
          <% } %>
          <% if (sale.deliveryDate) { %>
          <p class="card-text small mb-1">
            <strong>Delivery Date:</strong> <%= new Date(sale.deliveryDate).toLocaleDateString() %>
          </p>
          <% } else if (sale.orderDate) { %>
          <p class="card-text small mb-2 text-warning">
            <strong>Status:</strong> Awaiting Delivery
          </p>
          <% } %>
          <a
            href="/jobs/<%= sale._id.toString() %>"
            class="btn btn-sm btn-primary"
            >View Details</a
          >
        </div>
      </div>
      <% } %> <% }) %> <% } else { %>
      <div class="card" style="min-width: 320px">
        <div class="card-body text-muted">No pool sales found</div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Jobs Row -->
  <div class="mb-4">
    <h2 class="h5 mb-3">Recent Jobs</h2>
    <div
      class="d-flex flex-row flex-nowrap overflow-auto pb-3"
      style="gap: 1rem"
    >
      <% if (jobs && jobs.length > 0) { %> <% jobs.forEach(job => { %> <% if (job && job._id) { %>
      <div class="card" style="min-width: 300px">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <% let statusClass = 'secondary'; if (job.status === 'complete') statusClass = 'success'; else if (job.status === 'delayed') statusClass = 'warning'; else if (job.status === 'delivered') statusClass = 'info'; %>
            <span class="badge bg-<%= statusClass %>">
              <%= job.status || 'pending' %>
            </span>
            <span class="badge bg-<%= job.isPaid ? 'success' : 'danger' %>">
              <%= job.isPaid ? 'Paid' : 'Unpaid' %>
            </span>
          </div>
          <h5 class="card-title">
            <%= job.customer && job.customer.name ? job.customer.name : 'Unknown Customer' %>
          </h5>
          <p class="card-text small mb-1">
            <strong>Total:</strong> $<%= (job.totalPrice || 0).toFixed(2) %>
          </p>
          <p class="card-text small mb-1">
            <strong>Sold by:</strong>
            <%= job.soldByOwner ? 'Owner' : (job.salesRep && job.salesRep.name ? job.salesRep.name : 'N/A') %>
          </p>
          <p class="card-text small mb-1">
            <strong>Installer:</strong> <%= job.installer && job.installer.name ? job.installer.name : 'Not assigned' %>
          </p>
          <% if (job.installDate) { %>
          <p class="card-text small mb-2">
            <strong>Install Date:</strong> <%= new Date(job.installDate).toLocaleDateString() %>
          </p>
          <% } %>
          <a
            href="/jobs/<%= job._id.toString() %>"
            class="btn btn-sm btn-primary"
            >View Details</a
          >
        </div>
      </div>
      <% } %> <% }) %> <% } else { %>
      <div class="card" style="min-width: 300px">
        <div class="card-body text-muted">No jobs found</div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
