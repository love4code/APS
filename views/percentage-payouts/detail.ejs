<%- include('../partials/header', { title: 'Percentage Payout Details' }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Daily Payout Details</h1>
    <div class="d-flex gap-2">
      <form action="/payouts/<%= payout._id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this payout? This action cannot be undone.');">
        <button type="submit" class="btn btn-outline-danger">Delete</button>
      </form>
      <a href="/payouts" class="btn btn-outline-secondary">Back to Payouts</a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Payout Summary</h5>
          <div class="row">
            <div class="col-md-6">
              <% 
                const payoutDate = payout.date ? new Date(payout.date) : null;
                const dateStr = payoutDate ? (payoutDate.getUTCMonth() + 1) + '/' + payoutDate.getUTCDate() + '/' + payoutDate.getUTCFullYear() : 'N/A';
              %>
              <p><strong>Date:</strong> <%= dateStr %></p>
              <p><strong>Total Revenue:</strong> $<%= (payout.totalRevenue || 0).toFixed(2) %></p>
              <p><strong>Job Costs:</strong> $<%= (payout.jobCosts || 0).toFixed(2) %></p>
              <p><strong>Materials:</strong> $<%= (payout.materials || 0).toFixed(2) %></p>
              <p><strong>Labor Costs:</strong> $<%= (payout.laborCosts || 0).toFixed(2) %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Total Costs:</strong> $<%= (payout.totalCosts || 0).toFixed(2) %></p>
              <p><strong>Total Profit:</strong> <strong class="text-success">$<%= (payout.totalProfit || 0).toFixed(2) %></strong></p>
              <p><strong>Total Employee Payout:</strong> $<%= (payout.totalPercentagePayout || 0).toFixed(2) %></p>
              <p><strong>20% Company Payout:</strong> <strong class="text-success">$<%= (payout.calculatedPayout || 0).toFixed(2) %></strong></p>
              <p><strong>Created By:</strong> 
                <% if (payout.createdBy && payout.createdBy.name) { %>
                  <%= payout.createdBy.name %>
                <% } else { %>
                  N/A
                <% } %>
              </p>
            </div>
          </div>
          <% if (payout.notes) { %>
            <div class="mt-3">
              <strong>Notes:</strong>
              <p class="text-muted"><%= payout.notes %></p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Employee Payouts -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Employee Payouts</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Pay Type</th>
                  <th>Rate</th>
                  <th>Hours</th>
                  <th>Payout Amount</th>
                </tr>
              </thead>
              <tbody>
                <% if (payout.employeePayouts && payout.employeePayouts.length > 0) { %>
                  <% for (let i = 0; i < payout.employeePayouts.length; i++) { 
                    const empPayout = payout.employeePayouts[i];
                    const payTypeBadge = empPayout.payType === 'percentage' ? 'info' : (empPayout.payType === 'hourly' ? 'primary' : 'secondary');
                    const payTypeLabel = empPayout.payType === 'percentage' ? 'Percentage' : (empPayout.payType === 'hourly' ? 'Hourly' : 'N/A');
                    let rateStr = 'N/A';
                    let hoursStr = 'N/A';
                    let hasFlatRate = false;
                    if (empPayout.payType === 'percentage') {
                      rateStr = (empPayout.percentageRate || 0).toFixed(2) + '%';
                      hoursStr = 'N/A';
                    } else if (empPayout.payType === 'hourly') {
                      // If flat rate exists, show flat rate instead of hourly rate
                      if (empPayout.flatRate && empPayout.flatRate > 0) {
                        hasFlatRate = true;
                        rateStr = (empPayout.flatRate || 0).toFixed(2);
                        hoursStr = 'N/A';
                      } else {
                        rateStr = '$' + (empPayout.hourlyRate || 0).toFixed(2) + '/hr';
                        hoursStr = empPayout.hours ? (empPayout.hours || 0).toFixed(2) + ' hrs' : 'N/A';
                      }
                    }
                  %>
                    <tr>
                      <td>
                        <% if (empPayout.employee && empPayout.employee.firstName) { %>
                          <a href="/employees/<%= empPayout.employee._id %>">
                            <%= empPayout.employee.firstName %> <%= empPayout.employee.lastName %>
                          </a>
                        <% } else { %>
                          Unknown Employee
                        <% } %>
                      </td>
                      <td>
                        <span class="badge bg-<%= payTypeBadge %>"><%= payTypeLabel %></span>
                      </td>
                      <td>
                        <% if (hasFlatRate) { %>
                          <span class="text-info fw-bold">Flat Rate: $<%= rateStr %></span>
                        <% } else { %>
                          <%= rateStr %>
                        <% } %>
                      </td>
                      <td><%= hoursStr %></td>
                      <td class="text-success fw-bold">$<%= (empPayout.payoutAmount || 0).toFixed(2) %></td>
                    </tr>
                  <% } %>
                <% } else { %>
                  <tr>
                    <td colspan="5" class="text-center text-muted">No employee payouts</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

