<%- include('../partials/header', { title: employee.fullName || (employee.firstName + ' ' + employee.lastName) }) %>

<%
  // Declare payTypes once at the top to avoid redeclaration errors
  const payTypes = Array.isArray(employee.payType) ? employee.payType : [employee.payType];
  const hasPercentage = payTypes.includes('percentage');
  const hasHourly = payTypes.includes('hourly');
  const canCalculatePayout = hasPercentage; // Only show for percentage employees
%>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3"><%= employee.firstName %> <%= employee.lastName %></h1>
    <div class="d-flex gap-2 employee-action-buttons">
      <a href="/employees/<%= employee._id %>/edit" class="btn btn-outline-primary" title="Edit">
        <i class="bi bi-pencil"></i>
        <span class="btn-text">Edit</span>
      </a>
      <a href="/time-entries/new?employeeId=<%= employee._id %>" class="btn btn-primary" title="Add Time Entry">
        <i class="bi bi-clock"></i>
        <span class="btn-text">Add Time Entry</span>
      </a>
      <a href="/payments/new?employeeId=<%= employee._id %>" class="btn btn-success" title="Record Payment">
        <i class="bi bi-cash-coin"></i>
        <span class="btn-text">Record Payment</span>
      </a>
      <% if (canCalculatePayout) { %>
        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#calculatePayoutModal" title="Calculate Daily Payout">
          <i class="bi bi-calculator"></i>
          <span class="btn-text">Calculate Daily Payout</span>
        </button>
      <% } %>
      <a href="/employees" class="btn btn-outline-secondary" title="Back to Employees">
        <i class="bi bi-arrow-left"></i>
        <span class="btn-text">Back to Employees</span>
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <!-- Employee Information -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Employee Information</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Email:</strong> <%= employee.email || 'N/A' %></p>
              <p><strong>Phone:</strong> <%= employee.phone || 'N/A' %></p>
              <p><strong>Position:</strong> <%= employee.position %></p>
              <p><strong>Department:</strong> <%= employee.department %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Status:</strong> 
                <% 
                  let statusClass = 'secondary';
                  if (employee.status === 'active') statusClass = 'success';
                  else if (employee.status === 'terminated') statusClass = 'danger';
                  else if (employee.status === 'on_leave') statusClass = 'warning';
                %>
                <span class="badge bg-<%= statusClass %>"><%= employee.status %></span>
              </p>
              <p><strong>Hire Date:</strong> <%= employee.hireDate ? (() => { const d = new Date(employee.hireDate); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() : 'N/A' %></p>
              <% if (employee.terminationDate) { %>
                <p><strong>Termination Date:</strong> <%= (() => { const d = new Date(employee.terminationDate); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() %></p>
              <% } %>
              <p><strong>Pay Type:</strong> 
                <% 
                  const payTypeLabels = payTypes.map(pt => {
                    if (pt === 'hourly') return 'Hourly';
                    if (pt === 'salary') return 'Salary';
                    if (pt === 'percentage') return 'Percentage';
                    return pt;
                  });
                %>
                <%= payTypeLabels.join(', ') %>
              </p>
              <p><strong>Rate:</strong> 
                <% 
                  let rateDisplay = [];
                  if (payTypes.includes('hourly')) {
                    rateDisplay.push('$' + (employee.hourlyRate || 0).toFixed(2) + '/hr');
                  }
                  if (payTypes.includes('salary')) {
                    rateDisplay.push('$' + ((employee.annualSalary || 0) / 52).toFixed(2) + '/wk');
                  }
                  if (payTypes.includes('percentage')) {
                    rateDisplay.push((employee.percentageRate || 0).toFixed(2) + '%');
                  }
                %>
                <%= rateDisplay.length > 0 ? rateDisplay.join(', ') : 'N/A' %>
              </p>
            </div>
          </div>
          <% if (employee.notes) { %>
            <div class="mt-3">
              <strong>Notes:</strong>
              <p class="text-muted"><%= employee.notes %></p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Monthly Stats -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">This Month's Summary</h5>
          <div class="row">
            <div class="col-md-4">
              <div class="text-center">
                <h4><%= (monthlyStats.totalHours || 0).toFixed(2) %></h4>
                <p class="text-muted mb-0">Total Hours</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center">
                <h4><%= (monthlyStats.totalOvertime || 0).toFixed(2) %></h4>
                <p class="text-muted mb-0">Overtime Hours</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center">
                <h4><%= (monthlyStats.totalPTO || 0).toFixed(2) %></h4>
                <p class="text-muted mb-0">PTO Hours</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hourly Payout Summary (for hourly employees only) -->
      <% if (hasHourly && typeof hourlyPayoutTotal !== 'undefined') { %>
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Hourly Payout Summary</h5>
            <div class="mb-3">
              <p class="mb-0">
                <strong>Total Payout from Approved Time Entries: </strong>
                <span class="text-success fs-4 fw-bold">$<%= (hourlyPayoutTotal || 0).toFixed(2) %></span>
              </p>
              <small class="text-muted">Calculated from all approved time entries (regular hours + overtime + flat rate)</small>
            </div>
            <% if (hourlyPayoutBreakdown && hourlyPayoutBreakdown.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Regular Hours</th>
                      <th>Overtime Hours</th>
                      <th>Regular Pay</th>
                      <th>Overtime Pay</th>
                      <th>Flat Rate</th>
                      <th>Total Pay</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% hourlyPayoutBreakdown.slice(0, 10).forEach(breakdown => { %>
                      <tr>
                        <td>
                          <%
                            const bDate = breakdown.date ? new Date(breakdown.date) : null;
                            const bDateStr = bDate ? (bDate.getUTCMonth() + 1) + '/' + bDate.getUTCDate() + '/' + bDate.getUTCFullYear() : 'N/A';
                          %>
                          <%= bDateStr %>
                        </td>
                        <td><%= (breakdown.regularHours || 0).toFixed(2) %></td>
                        <td><%= (breakdown.overtimeHours || 0).toFixed(2) %></td>
                        <td>$<%= (breakdown.regularPay || 0).toFixed(2) %></td>
                        <td>$<%= (breakdown.overtimePay || 0).toFixed(2) %></td>
                        <td><% if (breakdown.flatRate && breakdown.flatRate > 0) { %>
                          <span class="text-info fw-bold">$<%= (breakdown.flatRate || 0).toFixed(2) %></span>
                        <% } else { %>
                          $0.00
                        <% } %></td>
                        <td class="text-success fw-bold">$<%= (breakdown.totalPay || 0).toFixed(2) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
              <% if (hourlyPayoutBreakdown.length > 10) { %>
                <p class="text-muted small">Showing first 10 entries. Total: <%= hourlyPayoutBreakdown.length %> approved time entries</p>
              <% } %>
            <% } else { %>
              <p class="text-muted">No approved time entries yet</p>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- Recent Time Entries -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Recent Time Entries</h5>
            <a href="/time-entries?employee=<%= employee._id %>" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
          <% if (recentTimeEntries && recentTimeEntries.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Hours</th>
                    <th>Overtime</th>
                    <th>Type</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% recentTimeEntries.forEach(entry => { %>
                    <tr>
                      <td><%= entry.date ? (() => { const d = new Date(entry.date); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() : '-' %></td>
                      <td><%= (entry.hoursWorked || 0).toFixed(2) %></td>
                      <td><%= (entry.overtimeHours || 0).toFixed(2) %></td>
                      <td><%= entry.type %></td>
                      <td>
                        <span class="badge bg-<%= entry.approved ? 'success' : 'warning' %>">
                          <%= entry.approved ? 'Approved' : 'Pending' %>
                        </span>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="text-muted">No time entries yet</p>
          <% } %>
        </div>
      </div>

          <!-- Recent Payroll Records -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Recent Payroll Records</h5>
                <a href="/payroll-records?employee=<%= employee._id %>" class="btn btn-sm btn-outline-primary">View All</a>
              </div>
              <% if (recentPayrollRecords && recentPayrollRecords.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Pay Period</th>
                        <th>Regular Hours</th>
                        <th>Overtime Hours</th>
                        <th>Gross Pay</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% recentPayrollRecords.forEach(record => { %>
                        <tr>
                          <td>
                            <% if (record.payPeriod) { %>
                              <a href="/pay-periods/<%= record.payPeriod._id %>"><%= record.payPeriod.name %></a>
                            <% } else { %>
                              N/A
                            <% } %>
                          </td>
                          <td><%= (record.totalRegularHours || 0).toFixed(2) %></td>
                          <td><%= (record.totalOvertimeHours || 0).toFixed(2) %></td>
                          <td>
                            $<%= (record.totalGrossPay || 0).toFixed(2) %>
                            <% if (record.totalDailyPayouts && record.totalDailyPayouts > 0) { %>
                              <br><small class="text-info">(includes $<%= (record.totalDailyPayouts || 0).toFixed(2) %> daily payouts)</small>
                            <% } %>
                          </td>
                          <td>
                            <%
                              let payStatusClass = 'danger';
                              if (record.paymentStatus === 'paid') payStatusClass = 'success';
                              else if (record.paymentStatus === 'scheduled') payStatusClass = 'info';
                            %>
                            <span class="badge bg-<%= payStatusClass %>"><%= record.paymentStatus %></span>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted">No payroll records yet</p>
              <% } %>
            </div>
          </div>

          <!-- Recent Percentage Payouts -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Daily Payouts</h5>
                <a href="/payouts" class="btn btn-sm btn-outline-primary">View All</a>
              </div>
              <% 
                // Debug: log what we have
                console.log('[Employee Detail View] recentPayouts:', recentPayouts ? recentPayouts.length : 'null');
                console.log('[Employee Detail View] totalPayoutAmount:', totalPayoutAmount);
                if (recentPayouts && recentPayouts.length > 0) {
                  console.log('[Employee Detail View] First payout:', {
                    _id: recentPayouts[0]._id,
                    employeePayoutsCount: recentPayouts[0].employeePayouts ? recentPayouts[0].employeePayouts.length : 0
                  });
                }
              %>
              <% if (recentPayouts && recentPayouts.length > 0) { %>
                <div class="mb-3">
                  <strong>Total Payout Amount: </strong>
                  <% const totalPayout = (totalPayoutAmount || 0).toFixed(2); %>
                  <span class="text-success fs-5">$<%= totalPayout %></span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Pay Type</th>
                        <th>Rate</th>
                        <th>Payout Amount</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% 
                        // Controller already filtered, so each payout in recentPayouts contains ONLY this employee's payout
                        if (recentPayouts && recentPayouts.length > 0) {
                          for (let pIdx = 0; pIdx < recentPayouts.length; pIdx++) {
                            const payout = recentPayouts[pIdx];
                            // Controller already filtered, so employeePayouts[0] is this employee's payout
                            const empPayout = payout.employeePayouts && payout.employeePayouts.length > 0 
                              ? payout.employeePayouts[0] 
                              : null;
                            
                            if (empPayout) {
                      %>
                        <tr>
                          <td>
                            <% 
                              let dateStr = 'N/A';
                              if (payout.date) {
                                const d = new Date(payout.date);
                                dateStr = (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear();
                              }
                            %>
                            <%= dateStr %>
                          </td>
                          <td>
                            <% if (empPayout.payType === 'percentage') { %>
                              <span class="badge bg-info">Percentage</span>
                            <% } else if (empPayout.payType === 'hourly') { %>
                              <span class="badge bg-primary">Hourly</span>
                            <% } else { %>
                              <span class="badge bg-secondary">N/A</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (empPayout.payType === 'percentage') { %>
                              <%= (empPayout.percentageRate || 0).toFixed(2) + '%' %>
                            <% } else if (empPayout.payType === 'hourly') { %>
                              <% if (empPayout.flatRate && empPayout.flatRate > 0) { %>
                                <span class="text-info fw-bold">Flat Rate: $<%= (empPayout.flatRate || 0).toFixed(2) %></span>
                              <% } else { %>
                                $<%= (empPayout.hourlyRate || 0).toFixed(2) %>/hr × <%= (empPayout.hours || 0).toFixed(2) %> hrs
                              <% } %>
                            <% } else { %>
                              N/A
                            <% } %>
                          </td>
                          <td class="text-success fw-bold">$<%= (empPayout.payoutAmount || 0).toFixed(2) %></td>
                          <td>
                            <a href="/payouts/<%= payout._id %>" class="btn btn-sm btn-outline-primary">View Details</a>
                          </td>
                        </tr>
                      <% 
                            }
                          }
                        }
                      %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted">No daily payouts yet</p>
              <% } %>
            </div>
          </div>

          <!-- Weekly Payouts -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Weekly Payouts</h5>
              </div>

              <!-- Week Filter -->
              <div class="card mb-3">
                <div class="card-body">
                  <form method="GET" action="/employees/<%= employee._id %>" class="row g-3">
                    <div class="col-md-4">
                      <label for="weekStart" class="form-label">Week Start (Monday)</label>
                      <input type="date" class="form-control" id="weekStart" name="weekStart" value="<%= typeof weekStart !== 'undefined' ? weekStart : '' %>">
                    </div>
                    <div class="col-md-4">
                      <label for="weekEnd" class="form-label">Week End (Sunday)</label>
                      <input type="date" class="form-control" id="weekEnd" name="weekEnd" value="<%= typeof weekEnd !== 'undefined' ? weekEnd : '' %>">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Filter Week
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Weekly Summary -->
              <% if (typeof weeklyTotal !== 'undefined') { %>
                <div class="row mb-3">
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <h4 class="text-success mb-0">$<%= (weeklyTotal || 0).toFixed(2) %></h4>
                        <p class="text-muted mb-0">Total Payouts</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <h4 class="text-primary mb-0">$<%= (weeklyPayrollTotal || 0).toFixed(2) %></h4>
                        <p class="text-muted mb-0">Total Payroll</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <h4 class="text-warning mb-0">$<%= (weeklyTimeEntriesTotal || 0).toFixed(2) %></h4>
                        <p class="text-muted mb-0">Time Entries</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <%
                          // Calculate total weekly
                          // For percentage employees: weeklyTotal already includes daily payouts + time entries
                          // For hourly employees: weeklyTotal is just time entries
                          // So we only need to add weeklyPayrollTotal
                          const totalWeekly = (weeklyTotal || 0) + (weeklyPayrollTotal || 0);
                        %>
                        <h4 class="text-info mb-0">$<%= totalWeekly.toFixed(2) %></h4>
                        <p class="text-muted mb-0">Total Weekly</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Weekly Payout Details -->
                <% if ((weeklyPayoutDetails && weeklyPayoutDetails.length > 0) || (weeklyPayroll && weeklyPayroll.length > 0) || (weeklyTimeEntries && weeklyTimeEntries.length > 0)) { %>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Type</th>
                          <th>Rate/Details</th>
                          <th>Submitted</th>
                          <th>Amount</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% weeklyPayoutDetails.forEach(p => { 
                          const pDate = p.date ? new Date(p.date) : null;
                          const pDateStr = pDate ? (pDate.getUTCMonth() + 1) + '/' + pDate.getUTCDate() + '/' + pDate.getUTCFullYear() : 'N/A';
                          const submittedDate = p.createdAt ? new Date(p.createdAt) : null;
                          const submittedDateStr = submittedDate ? (submittedDate.getUTCMonth() + 1) + '/' + submittedDate.getUTCDate() + '/' + submittedDate.getUTCFullYear() + ' ' + 
                            (submittedDate.getUTCHours() % 12 || 12) + ':' + String(submittedDate.getUTCMinutes()).padStart(2, '0') + ' ' + (submittedDate.getUTCHours() >= 12 ? 'PM' : 'AM') : 'N/A';
                          let rateStr = 'N/A';
                          if (p.payType === 'percentage') {
                            rateStr = (p.percentageRate || 0).toFixed(2) + '%';
                          } else if (p.payType === 'hourly') {
                            // If flat rate exists, show flat rate instead of hourly rate
                            if (p.flatRate && p.flatRate > 0) {
                              rateStr = 'Flat Rate: $' + (p.flatRate || 0).toFixed(2);
                            } else {
                              rateStr = '$' + (p.hourlyRate || 0).toFixed(2) + '/hr × ' + (p.hours || 0).toFixed(2) + ' hrs';
                            }
                          }
                        %>
                          <tr>
                            <td><%= pDateStr %></td>
                            <td>
                              <% if (p.payType === 'percentage') { %>
                                <span class="badge bg-info">Percentage</span>
                              <% } else if (p.payType === 'hourly') { %>
                                <span class="badge bg-primary">Hourly</span>
                              <% } else { %>
                                <span class="badge bg-secondary">N/A</span>
                              <% } %>
                            </td>
                            <td><%= rateStr %></td>
                            <td><small class="text-muted"><%= submittedDateStr %></small></td>
                            <td class="text-success fw-bold">$<%= (p.payoutAmount || 0).toFixed(2) %></td>
                            <td>
                              <a href="/payouts/<%= p.payoutId %>" class="btn btn-sm btn-outline-primary">View Details</a>
                            </td>
                          </tr>
                        <% }) %>
                        <% if (weeklyPayroll && weeklyPayroll.length > 0) { %>
                          <% weeklyPayroll.forEach(record => { %>
                            <tr>
                              <td>
                                <% if (record.payPeriod && record.payPeriod.startDate) { %>
                                  <% const startDate = new Date(record.payPeriod.startDate); %>
                                  <%= (startDate.getUTCMonth() + 1) + '/' + startDate.getUTCDate() + '/' + startDate.getUTCFullYear() %>
                                <% } else { %>
                                  N/A
                                <% } %>
                              </td>
                              <td><span class="badge bg-success">Payroll</span></td>
                              <td>
                                <% if (record.payPeriod) { %>
                                  <%= record.payPeriod.name %>
                                <% } else { %>
                                  N/A
                                <% } %>
                              </td>
                              <td>
                                <% if (record.createdAt) { %>
                                  <% const createdDate = new Date(record.createdAt); %>
                                  <small class="text-muted"><%= (createdDate.getUTCMonth() + 1) + '/' + createdDate.getUTCDate() + '/' + createdDate.getUTCFullYear() %></small>
                                <% } else { %>
                                  <small class="text-muted">N/A</small>
                                <% } %>
                              </td>
                              <td class="text-success fw-bold">$<%= ((record.totalGrossPay || 0) + (record.totalDailyPayouts || 0)).toFixed(2) %></td>
                              <td>
                                <a href="/payroll-records/<%= record._id %>" class="btn btn-sm btn-outline-primary">View Details</a>
                              </td>
                            </tr>
                          <% }) %>
                        <% } %>
                        <% if (weeklyTimeEntries && weeklyTimeEntries.length > 0) { %>
                          <% weeklyTimeEntries.forEach(entry => { %>
                            <tr>
                              <td>
                                <% const entryDate = entry.date ? new Date(entry.date) : null; %>
                                <% const entryDateStr = entryDate ? (entryDate.getUTCMonth() + 1) + '/' + entryDate.getUTCDate() + '/' + entryDate.getUTCFullYear() : 'N/A'; %>
                                <%= entryDateStr %>
                              </td>
                              <td>
                                <span class="badge bg-warning">Time Entry</span>
                                <% if (!entry.approved) { %>
                                  <span class="badge bg-secondary">Pending</span>
                                <% } %>
                              </td>
                              <td>
                                <small>
                                  <% if (entry.flatRate && entry.flatRate > 0) { %>
                                    <span class="text-info fw-bold">Flat Rate: $<%= (entry.flatRate || 0).toFixed(2) %></span>
                                  <% } else { %>
                                    <%= (entry.hoursWorked || 0).toFixed(2) %> hrs
                                    <% if (entry.overtimeHours && entry.overtimeHours > 0) { %>
                                      (<%= (entry.overtimeHours || 0).toFixed(2) %> OT)
                                    <% } %>
                                    <% if (entry.type && entry.type !== 'regular') { %>
                                      - <%= entry.type %>
                                    <% } %>
                                  <% } %>
                                </small>
                              </td>
                              <td>
                                <% if (entry.createdAt) { %>
                                  <% const createdDate = new Date(entry.createdAt); %>
                                  <small class="text-muted"><%= (createdDate.getUTCMonth() + 1) + '/' + createdDate.getUTCDate() + '/' + createdDate.getUTCFullYear() %></small>
                                <% } else { %>
                                  <small class="text-muted">N/A</small>
                                <% } %>
                              </td>
                              <td class="text-success fw-bold">
                                <% if (entry.calculatedPay && entry.calculatedPay > 0) { %>
                                  $<%= (entry.calculatedPay || 0).toFixed(2) %>
                                <% } else { %>
                                  <span class="text-muted">-</span>
                                <% } %>
                              </td>
                              <td>
                                <a href="/time-entries/<%= entry._id %>" class="btn btn-sm btn-outline-primary">View</a>
                              </td>
                            </tr>
                          <% }) %>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                <% } else { %>
                  <p class="text-muted">No payouts, payroll records, or time entries found for this week.</p>
                <% } %>
              <% } else { %>
                <p class="text-muted">Select a week to view weekly payouts.</p>
              <% } %>
            </div>
          </div>

          <!-- Payments -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Payments</h5>
                <a href="/payments/new?employeeId=<%= employee._id %>" class="btn btn-sm btn-success">
                  <i class="bi bi-plus-circle"></i> Record Payment
                </a>
              </div>

              <!-- Payment Date Filter -->
              <div class="card mb-3">
                <div class="card-body">
                  <form method="GET" action="/employees/<%= employee._id %>" class="row g-3">
                    <input type="hidden" name="weekStart" value="<%= typeof weekStart !== 'undefined' ? weekStart : '' %>">
                    <input type="hidden" name="weekEnd" value="<%= typeof weekEnd !== 'undefined' ? weekEnd : '' %>">
                    <div class="col-md-5">
                      <label for="paymentDateFrom" class="form-label">Date From</label>
                      <input type="date" class="form-control" id="paymentDateFrom" name="paymentDateFrom" value="<%= typeof paymentDateFrom !== 'undefined' ? paymentDateFrom : '' %>">
                    </div>
                    <div class="col-md-5">
                      <label for="paymentDateTo" class="form-label">Date To</label>
                      <input type="date" class="form-control" id="paymentDateTo" name="paymentDateTo" value="<%= typeof paymentDateTo !== 'undefined' ? paymentDateTo : '' %>">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="submit" class="btn btn-primary w-100 me-2">
                        <i class="bi bi-search"></i> Filter
                      </button>
                    </div>
                  </form>
                  <% if (typeof paymentDateFrom !== 'undefined' && paymentDateFrom) { %>
                    <div class="mt-2">
                      <a href="/employees/<%= employee._id %>?weekStart=<%= typeof weekStart !== 'undefined' ? weekStart : '' %>&weekEnd=<%= typeof weekEnd !== 'undefined' ? weekEnd : '' %>" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Clear Filter
                      </a>
                    </div>
                  <% } %>
                </div>
              </div>

              <!-- Payment Summary -->
              <% if (typeof totalPaymentsAmount !== 'undefined') { %>
                <div class="mb-3">
                  <strong>Total Payments: </strong>
                  <span class="text-success fs-5">$<%= (totalPaymentsAmount || 0).toFixed(2) %></span>
                </div>
              <% } %>

              <!-- Payments Table -->
              <% if (typeof employeePayments !== 'undefined' && employeePayments && employeePayments.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Jobs</th>
                        <th>Customers</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% employeePayments.forEach(payment => { 
                        // Get jobs from jobs array, or fall back to single job for backward compatibility
                        let displayJobs = [];
                        if (payment.jobs && payment.jobs.length > 0) {
                          displayJobs = payment.jobs;
                        } else if (payment.job) {
                          displayJobs = [payment.job];
                        }
                      %>
                        <tr>
                          <td>
                            <% 
                              const pDate = payment.datePaid ? new Date(payment.datePaid) : null;
                              const pDateStr = pDate ? (pDate.getUTCMonth() + 1) + '/' + pDate.getUTCDate() + '/' + pDate.getUTCFullYear() : 'N/A';
                            %>
                            <%= pDateStr %>
                          </td>
                          <td>
                            <% if (displayJobs.length > 0) { %>
                              <% displayJobs.forEach((job, index) => { %>
                                <a href="/jobs/<%= job._id %>">
                                  Job #<%= job._id.toString().slice(-6) %>
                                </a>
                                <% if (index < displayJobs.length - 1) { %>, <% } %>
                              <% }) %>
                            <% } else { %>
                              N/A
                            <% } %>
                          </td>
                          <td>
                            <% if (displayJobs.length > 0) { %>
                              <% displayJobs.forEach((job, index) => { %>
                                <% if (job.customer) { %>
                                  <a href="/customers/<%= job.customer._id %>">
                                    <%= job.customer.name %>
                                  </a>
                                <% } else { %>N/A<% } %>
                                <% if (index < displayJobs.length - 1) { %>, <% } %>
                              <% }) %>
                            <% } else { %>
                              N/A
                            <% } %>
                          </td>
                          <td class="text-success fw-bold">$<%= (payment.amount || 0).toFixed(2) %></td>
                          <td>
                            <span class="badge bg-secondary">
                              <%= payment.paymentMethod ? payment.paymentMethod.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A' %>
                            </span>
                            <% if (payment.paymentMethod === 'check' && payment.checkNumber) { %>
                              <br><small class="text-muted">Check #<%= payment.checkNumber %></small>
                            <% } %>
                          </td>
                          <td>
                            <a href="/payments/<%= payment._id %>" class="btn btn-sm btn-outline-primary">View</a>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted">No payments recorded<% if (typeof paymentDateFrom !== 'undefined' && paymentDateFrom) { %> for the selected date range<% } %>.</p>
              <% } %>
            </div>
          </div>
    </div>

    <div class="col-md-4">
      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Quick Actions</h5>
          <div class="d-grid gap-2">
            <a href="/time-entries/new?employeeId=<%= employee._id %>" class="btn btn-outline-primary">
              <i class="bi bi-clock"></i> Add Time Entry
            </a>
            <a href="/payments/new?employeeId=<%= employee._id %>" class="btn btn-outline-success">
              <i class="bi bi-cash-coin"></i> Record Payment
            </a>
            <% if (canCalculatePayout) { %>
              <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#calculatePayoutModal">
                <i class="bi bi-calculator"></i> Calculate Daily Payout
              </button>
            <% } %>
            <% if (employee.status === 'active') { %>
              <form action="/employees/<%= employee._id %>/archive" method="POST" class="d-inline">
                <input type="hidden" name="action" value="inactive">
                <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Mark employee as inactive?')">
                  <i class="bi bi-pause-circle"></i> Mark Inactive
                </button>
              </form>
            <% } %>
            <% if (employee.status !== 'terminated') { %>
              <form action="/employees/<%= employee._id %>/archive" method="POST" class="d-inline">
                <input type="hidden" name="action" value="terminated">
                <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Terminate this employee? This action cannot be undone.')">
                  <i class="bi bi-x-circle"></i> Terminate
                </button>
              </form>
            <% } %>
            <form action="/employees/<%= employee._id %>/delete" method="POST" class="d-inline">
              <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to delete this employee? This action cannot be undone. You must delete all related time entries, payroll records, and payouts first.')">
                <i class="bi bi-trash"></i> Delete Employee
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calculate Payout Modal -->
<div class="modal fade" id="calculatePayoutModal" tabindex="-1" aria-labelledby="calculatePayoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calculatePayoutModalLabel">Calculate Daily Payout</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="payoutForm">
          <div class="mb-3">
            <label for="payoutDate" class="form-label">Date *</label>
            <input type="date" class="form-control" id="payoutDate" name="date" required value="<%= new Date().toISOString().split('T')[0] %>" onchange="handleDateChange()">
          </div>

          <div class="mb-3">
            <label for="totalRevenue" class="form-label">Total Revenue *</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="totalRevenue" name="totalRevenue" step="0.01" min="0" required onchange="calculatePayout()">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label for="jobCosts" class="form-label">Job Costs</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="jobCosts" name="jobCosts" step="0.01" min="0" value="0" onchange="calculatePayout()">
              </div>
            </div>
            <div class="col-md-4">
              <label for="materials" class="form-label">Materials</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="materials" name="materials" step="0.01" min="0" value="0" onchange="calculatePayout()">
              </div>
            </div>
            <div class="col-md-4">
              <label for="laborCosts" class="form-label">Labor Costs</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="laborCosts" name="laborCosts" step="0.01" min="0" value="0" onchange="calculatePayout()" readonly>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="calculateLaborCosts()" title="Auto-calculate from time entries">
                  <i class="bi bi-calculator"></i> Auto
                </button>
              </div>
              <small class="text-muted">Click "Auto" to calculate from time entries</small>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Employees *</label>
            <div id="employeePayoutsContainer">
              <div class="employee-payout-row mb-3 p-3 border rounded">
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label small">Employee</label>
                    <div class="employee-search-wrapper" style="position: relative;">
                      <input type="text" class="form-control employee-search-input" placeholder="Search employees..." autocomplete="off" required>
                      <input type="hidden" class="employee-id-input" name="employeePayouts[0][employeeId]">
                      <div class="employee-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; z-index: 10000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small">Pay Type</label>
                    <select class="form-select pay-type-select" name="employeePayouts[0][payType]" onchange="togglePayTypeInput(this); calculatePayout();" required>
                      <option value="percentage">Percentage</option>
                      <option value="hourly">Hourly</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small">Payout Amount</label>
                    <div class="payout-amount text-success fw-bold fs-5">$0.00</div>
                  </div>
                  <div class="col-md-1">
                    <label class="form-label small">&nbsp;</label>
                    <button type="button" class="btn btn-sm btn-danger w-100 remove-employee" onclick="removeEmployeeRow(this)">
                      <i class="bi bi-x"></i> Remove
                    </button>
                  </div>
                </div>
                <div class="row g-3 mt-2">
                  <div class="col-md-6 percentage-input-group">
                    <label class="form-label small">Percentage Rate</label>
                    <div class="input-group">
                      <input type="number" class="form-control percentage-rate" name="employeePayouts[0][percentageRate]" step="0.01" min="0" max="100" placeholder="Enter percentage" onchange="calculatePayout()">
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addEmployeeRow()">
              <i class="bi bi-plus"></i> Add Employee
            </button>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Summary</h6>
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>Total Revenue:</strong> <span id="summaryRevenue">$0.00</span></p>
                  <p class="mb-1"><strong>Job Costs:</strong> <span id="summaryJobCosts">$0.00</span></p>
                  <p class="mb-1"><strong>Materials:</strong> <span id="summaryMaterials">$0.00</span></p>
                  <p class="mb-1"><strong>Labor Costs:</strong> <span id="summaryLaborCosts">$0.00</span></p>
                  <p class="mb-1"><strong>Total Costs:</strong> <span id="summaryCosts">$0.00</span></p>
                  <p class="mb-1"><strong>Total Profit:</strong> <span id="summaryProfit">$0.00</span></p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Total Employee Payout:</strong> <span id="summaryEmployeePayout">$0.00</span></p>
                  <p class="mb-1"><strong><span id="summaryPercentageLabel">0%</span> of Profit:</strong> <span id="summaryCalculatedPayout" class="text-success fw-bold">$0.00</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="payoutNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="payoutNotes" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePayout()">Save Payout</button>
      </div>
    </div>
  </div>
</div>

<script>
  let availableEmployees = [];
  let employeesWhoWorked = [];
  let timeEntriesByEmployee = {}; // Map employee ID to their time entries
  let employeeIndex = 1;

  // Load employees when modal opens or date changes
  async function loadEmployees(date) {
    try {
      const url = date ? `/payouts/calculate-form?date=${date}` : '/payouts/calculate-form';
      const response = await fetch(url);
      const data = await response.json();
      if (data.success) {
        availableEmployees = data.employees || [];
        employeesWhoWorked = data.employeesWhoWorked || [];
        timeEntriesByEmployee = data.timeEntriesByEmployee || {};
        
        // Debug logging
        console.log('Available employees (percentage):', availableEmployees.length);
        console.log('Employees who worked:', employeesWhoWorked.length);
        console.log('Time entries by employee:', timeEntriesByEmployee);
        
        initializeEmployeeSearch();
      }
    } catch (error) {
      console.error('Error loading employees:', error);
    }
  }

  // Initialize employee search functionality
  function initEmployeeSearch(wrapper, searchInput, employeeIdInput, percentageRateInput, payoutAmountSpan) {
    let isMouseOverDropdown = false;
    let isMouseOverWrapper = false;
    const dropdown = wrapper.querySelector('.employee-dropdown');

    function filterEmployees() {
      if (!searchInput || !dropdown) return;
      
      const searchTerm = searchInput.value.toLowerCase().trim();
      const date = document.getElementById('payoutDate').value;
      
      let filtered = [];
      
      console.log('[Employee Search] Filtering employees:', {
        date: date,
        searchTerm: searchTerm,
        employeesWhoWorkedCount: employeesWhoWorked.length,
        availableEmployeesCount: availableEmployees.length
      });
      
      // If date is selected, ONLY show employees who worked that day
      if (date && employeesWhoWorked.length > 0) {
        if (searchTerm.length > 0) {
          // Filter employees who worked by search term
          filtered = employeesWhoWorked.filter(emp => {
            const name = `${emp.firstName || ''} ${emp.lastName || ''}`.toLowerCase();
            return name.includes(searchTerm);
          });
        } else {
          // Show all employees who worked that day
          filtered = [...employeesWhoWorked];
        }
      } else if (date) {
        // Date selected but no employees worked - show empty
        filtered = [];
      } else {
        // No date selected - show all percentage employees
        if (searchTerm.length > 0) {
          filtered = availableEmployees.filter(emp => {
            const name = `${emp.firstName || ''} ${emp.lastName || ''}`.toLowerCase();
            return name.includes(searchTerm);
          });
        } else {
          filtered = [...availableEmployees];
        }
      }
      
      console.log('[Employee Search] Filtered results:', filtered.length);
      
      if (filtered.length > 0) {
        dropdown.style.display = 'block';
        dropdown.innerHTML = filtered.map(emp => {
          // Compare employee IDs properly (handle both string and ObjectId)
          const empId = emp._id ? (typeof emp._id === 'object' ? emp._id.toString() : String(emp._id)) : null;
          const workedToday = employeesWhoWorked.find(e => {
            const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
            return eId === empId;
          });
          const workedBadge = workedToday ? `<span class="badge bg-success ms-2">Worked Today</span>` : '';
          let laborCostText = '';
          if (workedToday) {
            const flatRate = workedToday.flatRate || 0;
            if (flatRate > 0) {
              laborCostText = ` (Flat Rate: $${flatRate.toFixed(2)})`;
            } else {
              laborCostText = ` (Labor: $${(workedToday.laborCost || 0).toFixed(2)})`;
            }
          }
          const laborCost = laborCostText;
          const payTypes = Array.isArray(emp.payType) ? emp.payType : [emp.payType];
          const hasPercentage = payTypes.includes('percentage');
          const hasHourly = payTypes.includes('hourly');
          const percentage = hasPercentage && emp.percentageRate ? ` (${emp.percentageRate}%)` : '';
          const hourly = hasHourly && emp.hourlyRate ? ` ($${emp.hourlyRate.toFixed(2)}/hr)` : '';
          const employeeIdStr = empId || (emp._id ? String(emp._id) : '');
          const flatRate = workedToday ? (workedToday.flatRate || 0) : 0;
          return `<div class="employee-option p-2 border-bottom" style="cursor: pointer; min-height: 44px; display: flex; align-items: center; -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1); touch-action: manipulation;" data-id="${employeeIdStr}" data-name="${emp.firstName} ${emp.lastName}" data-percentage="${hasPercentage ? (emp.percentageRate || '') : ''}" data-hourly-rate="${hasHourly ? (emp.hourlyRate || '') : ''}" data-flat-rate="${flatRate}">
            <div>
              <strong>${emp.firstName} ${emp.lastName}</strong>${percentage}${hourly}${workedBadge}
              ${laborCost ? `<div class="text-muted small">${laborCost}</div>` : ''}
            </div>
          </div>`;
        }).join('');
      } else {
        dropdown.style.display = 'none';
        dropdown.innerHTML = '';
      }
    }
    
    // Auto-show dropdown on focus or input
    searchInput.addEventListener('input', function() {
      filterEmployees();
    });
    
    searchInput.addEventListener('focus', function() {
      // Show dropdown immediately on focus
      filterEmployees();
    });
    
    // Also show dropdown when clicking/touching on the input
    const showDropdown = function(e) {
      e.stopPropagation();
      filterEmployees();
    };
    searchInput.addEventListener('click', showDropdown);
    searchInput.addEventListener('touchend', showDropdown);

    wrapper.addEventListener('mouseenter', () => { isMouseOverWrapper = true; });
    wrapper.addEventListener('mouseleave', () => {
      isMouseOverWrapper = false;
      setTimeout(() => {
        if (!isMouseOverDropdown && !isMouseOverWrapper) {
          dropdown.style.display = 'none';
        }
      }, 200);
    });

    dropdown.addEventListener('mouseenter', () => { isMouseOverDropdown = true; });
    dropdown.addEventListener('mouseleave', () => {
      isMouseOverDropdown = false;
      setTimeout(() => {
        if (!isMouseOverDropdown && !isMouseOverWrapper) {
          dropdown.style.display = 'none';
        }
      }, 200);
    });
    
    const handleEmployeeSelection = function(e) {
      const option = e.target.closest('.employee-option');
      if (option) {
        e.preventDefault();
        e.stopPropagation();
        const employeeId = option.getAttribute('data-id');
        const employeeName = option.getAttribute('data-name');
        const percentageRate = option.getAttribute('data-percentage');
        const hourlyRate = option.getAttribute('data-hourly-rate');
        const flatRate = parseFloat(option.getAttribute('data-flat-rate')) || 0;
        
        const row = wrapper.closest('.employee-payout-row');
        const payTypeSelect = row.querySelector('.pay-type-select');
        
        searchInput.value = employeeName;
        employeeIdInput.value = employeeId;
        
        // Get hours worked and flat rate from time entries if available
        const date = document.getElementById('payoutDate').value;
        let hoursWorked = 0;
        let entryFlatRate = 0;
        if (date && timeEntriesByEmployee[employeeId]) {
          const empTimeEntries = timeEntriesByEmployee[employeeId];
          hoursWorked = empTimeEntries.reduce((sum, entry) => sum + (entry.hoursWorked || 0), 0);
          entryFlatRate = empTimeEntries.reduce((sum, entry) => sum + (entry.flatRate || 0), 0);
        }
        
        // Use flat rate from employee data if available, otherwise from time entries
        const finalFlatRate = flatRate > 0 ? flatRate : entryFlatRate;
        
        // Get references to input fields
        const percentageRateInput = row.querySelector('.percentage-rate');
        
        // Auto-select pay type and fill in rate based on employee's pay types
        // Hourly data is calculated from time entries, no manual input needed
        if (percentageRate && hourlyRate) {
          // Employee has both, default to percentage but allow switching
          if (!payTypeSelect.value || payTypeSelect.value === 'percentage') {
            payTypeSelect.value = 'percentage';
            if (percentageRateInput) percentageRateInput.value = percentageRate;
          } else {
            payTypeSelect.value = 'hourly';
            // Hourly data will be calculated from time entries
          }
          togglePayTypeInput(payTypeSelect);
        } else if (percentageRate) {
          payTypeSelect.value = 'percentage';
          if (percentageRateInput) percentageRateInput.value = percentageRate;
          togglePayTypeInput(payTypeSelect);
        } else if (hourlyRate) {
          payTypeSelect.value = 'hourly';
          // Hourly data will be calculated from time entries
          togglePayTypeInput(payTypeSelect);
        } else if (hoursWorked > 0 || finalFlatRate > 0) {
          // If hours or flat rate available, set to hourly (data from time entries)
          payTypeSelect.value = 'hourly';
          togglePayTypeInput(payTypeSelect);
        }
        
        dropdown.style.display = 'none';
        
        // Trigger calculation after a short delay to ensure DOM is updated
        setTimeout(() => {
          calculatePayout();
        }, 50);
      }
    };
    
    // Support both click and touch events for mobile
    dropdown.addEventListener('click', handleEmployeeSelection);
    dropdown.addEventListener('touchend', handleEmployeeSelection);

    // Close dropdown when clicking/touching outside
    const closeDropdown = function(e) {
      if (!wrapper.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    };
    document.addEventListener('click', closeDropdown);
    document.addEventListener('touchend', closeDropdown);
  }

  function initializeEmployeeSearch() {
    document.querySelectorAll('.employee-search-wrapper').forEach(wrapper => {
      // Skip if already initialized
      if (wrapper.dataset.initialized === 'true') {
        return;
      }
      wrapper.dataset.initialized = 'true';
      
      const searchInput = wrapper.querySelector('.employee-search-input');
      const employeeIdInput = wrapper.querySelector('.employee-id-input');
      const row = wrapper.closest('.employee-payout-row');
      const percentageRateInput = row.querySelector('.percentage-rate');
      const payoutAmountSpan = row.querySelector('.payout-amount');
      
      if (searchInput && employeeIdInput) {
        initEmployeeSearch(wrapper, searchInput, employeeIdInput, percentageRateInput, payoutAmountSpan);
      }
    });
  }

  // Ensure modal is at body level (not moved by content organization script)
  function ensureModalAtBodyLevel() {
    const modal = document.getElementById('calculatePayoutModal');
    if (!modal) return;
    
    // If modal is not a direct child of body, move it there
    if (modal.parentElement !== document.body) {
      console.log('Moving modal to body level...');
      const parent = modal.parentElement;
      document.body.appendChild(modal);
      console.log('Modal moved to body');
    }
  }

  // Setup modal event listener when DOM is ready
  function setupModalListener() {
    const modal = document.getElementById('calculatePayoutModal');
    if (!modal) {
      console.error('Modal not found, retrying...');
      setTimeout(setupModalListener, 100);
      return;
    }

    // Ensure modal is at body level
    ensureModalAtBodyLevel();

    // Remove any existing listeners by using a flag
    if (modal.dataset.listenerAttached === 'true') {
      return; // Already attached
    }
    modal.dataset.listenerAttached = 'true';

    // Add event listener for when modal opens
    modal.addEventListener('show.bs.modal', async function() {
      console.log('=== MODAL OPENING ===');
      
      // Ensure modal is at body level
      ensureModalAtBodyLevel();
      
      // Force modal to be visible and interactive immediately
      const modalDialog = modal.querySelector('.modal-dialog');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');
      const form = document.getElementById('payoutForm');
      
      console.log('Modal elements:', {
        modal: modal,
        dialog: modalDialog,
        content: modalContent,
        body: modalBody,
        form: form
      });
      
      // Force styles immediately
      if (modal) {
        modal.style.display = 'block';
        modal.style.pointerEvents = 'none';
        modal.classList.add('show');
      }
      if (modalDialog) {
        modalDialog.style.pointerEvents = 'auto';
        modalDialog.style.zIndex = '1056';
      }
      if (modalContent) {
        modalContent.style.pointerEvents = 'auto';
        modalContent.style.zIndex = '1057';
      }
      if (modalBody) {
        modalBody.style.pointerEvents = 'auto';
      }
      if (form) {
        form.style.pointerEvents = 'auto';
        form.querySelectorAll('input, select, textarea, button').forEach(el => {
          if (el.type !== 'hidden') {
            el.disabled = false;
            el.readOnly = false;
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
            el.removeAttribute('readonly');
            el.removeAttribute('disabled');
          }
        });
      }

      const date = document.getElementById('payoutDate').value;
      await loadEmployees(date);
      
      // Recalculate after loading employees
      setTimeout(() => calculatePayout(), 200);
      
      // Pre-select the current employee if we're on an employee detail page
      const currentEmployeeId = '<%= employee._id %>';
      const currentEmployeeName = '<%= employee.firstName %> <%= employee.lastName %>';
      
      if (currentEmployeeId && currentEmployeeId !== 'undefined') {
        // Find the employee in availableEmployees
        const currentEmployee = availableEmployees.find(emp => emp._id === currentEmployeeId);
        if (currentEmployee) {
          // Pre-fill the first employee input with the current employee
          const firstRow = document.querySelector('.employee-payout-row');
          if (firstRow) {
            const searchInput = firstRow.querySelector('.employee-search-input');
            const employeeIdInput = firstRow.querySelector('.employee-id-input');
            
            if (searchInput && employeeIdInput) {
              searchInput.value = currentEmployeeName;
              employeeIdInput.value = currentEmployeeId;
              
              // Auto-select pay type and fill in rate if available
              const payTypeSelect = firstRow.querySelector('.pay-type-select');
              const percentageRateInput = firstRow.querySelector('.percentage-rate');
              
              const payTypes = Array.isArray(currentEmployee.payType) ? currentEmployee.payType : [currentEmployee.payType];
              const hasPercentage = payTypes.includes('percentage');
              const hasHourly = payTypes.includes('hourly');
              
              if (hasPercentage && hasHourly) {
                // Default to percentage if both available
                payTypeSelect.value = 'percentage';
                if (percentageRateInput && currentEmployee.percentageRate) {
                  percentageRateInput.value = currentEmployee.percentageRate;
                }
              } else if (hasPercentage) {
                payTypeSelect.value = 'percentage';
                if (percentageRateInput && currentEmployee.percentageRate) {
                  percentageRateInput.value = currentEmployee.percentageRate;
                }
              } else if (hasHourly) {
                payTypeSelect.value = 'hourly';
                // Hourly data will be calculated from time entries
                // Hourly data will be calculated from time entries automatically
              }
              
              // Trigger toggle to show/hide appropriate inputs
              if (payTypeSelect) {
                togglePayTypeInput(payTypeSelect);
                // Add event listener for pay type change
                payTypeSelect.addEventListener('change', function() {
                  togglePayTypeInput(this);
                  calculatePayout();
                });
              }
              
              // Add event listener for percentage rate change
              if (percentageRateInput) {
                percentageRateInput.addEventListener('change', calculatePayout);
                percentageRateInput.addEventListener('input', calculatePayout);
              }
              
              // Recalculate payout
              setTimeout(() => calculatePayout(), 100);
            }
          }
        }
      }
    });

    // Also listen for when modal is fully shown
    modal.addEventListener('shown.bs.modal', function() {
      console.log('=== MODAL FULLY SHOWN ===');
      const isMobile = window.innerWidth <= 768;
      console.log('Is mobile:', isMobile);
      
      // Ensure modal is at body level
      ensureModalAtBodyLevel();
      
      // Force all elements to be interactive
      const modalDialog = modal.querySelector('.modal-dialog');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');
      const form = document.getElementById('payoutForm');
      
      console.log('Modal structure check:', {
        modalParent: modal.parentElement?.tagName,
        modalDisplay: window.getComputedStyle(modal).display,
        modalZIndex: window.getComputedStyle(modal).zIndex,
        dialogPointerEvents: modalDialog ? window.getComputedStyle(modalDialog).pointerEvents : 'N/A',
        contentPointerEvents: modalContent ? window.getComputedStyle(modalContent).pointerEvents : 'N/A'
      });
      
      // Remove any blocking styles
      if (modal) {
        modal.style.pointerEvents = 'none';
      }
      
      if (modalDialog) {
        modalDialog.style.pointerEvents = 'auto';
        modalDialog.style.zIndex = '1056';
        modalDialog.style.position = 'relative';
      }
      
      if (modalContent) {
        modalContent.style.pointerEvents = 'auto';
        modalContent.style.zIndex = '1057';
        modalContent.style.position = 'relative';
      }
      
      if (modalBody) {
        modalBody.style.pointerEvents = 'auto';
        modalBody.style.zIndex = '1';
        modalBody.style.position = 'relative';
      }
      
      if (form) {
        form.style.pointerEvents = 'auto';
        form.style.position = 'relative';
        
        // Add click listeners to test if clicks are working
        form.addEventListener('click', function(e) {
          console.log('Form clicked:', e.target, e.currentTarget);
        }, true);
        
        form.querySelectorAll('input, select, textarea, button').forEach((el, index) => {
          if (el.type !== 'hidden') {
            el.disabled = false;
            el.readOnly = false;
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
            el.style.cursor = el.tagName === 'BUTTON' ? 'pointer' : 'text';
            el.style.position = 'relative';
            el.style.zIndex = '10';
            el.style.touchAction = 'manipulation';
            el.style.webkitTapHighlightColor = 'rgba(0, 0, 0, 0.1)';
            el.removeAttribute('readonly');
            el.removeAttribute('disabled');
            
            // Mobile-specific: ensure font size is at least 16px to prevent zoom
            if (isMobile && (el.tagName === 'INPUT' || el.tagName === 'SELECT')) {
              const computedFontSize = window.getComputedStyle(el).fontSize;
              const fontSizeNum = parseFloat(computedFontSize);
              if (fontSizeNum < 16) {
                el.style.fontSize = '16px';
              }
            }
            
            // Add click/touch handlers
            const handleInteraction = function(e) {
              console.log(`Element ${index} (${el.tagName}) interacted:`, el, e.type);
              e.stopPropagation();
              if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
                // Small delay to ensure focus works on mobile
                setTimeout(() => {
                  this.focus();
                }, 10);
              }
            };
            
            el.addEventListener('click', handleInteraction, { once: false });
            el.addEventListener('touchend', handleInteraction, { once: false });
            
            // Force focus capability
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
              el.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                console.log('Mousedown on input:', el);
              });
              el.addEventListener('touchstart', function(e) {
                e.stopPropagation();
                console.log('Touchstart on input:', el);
              });
            }
          }
        });
        
        // Make buttons clickable
        form.querySelectorAll('button').forEach(btn => {
          btn.style.pointerEvents = 'auto';
          btn.style.cursor = 'pointer';
          btn.style.zIndex = '10';
          btn.style.touchAction = 'manipulation';
          btn.style.minHeight = isMobile ? '44px' : 'auto';
          btn.disabled = false;
          
          const handleButtonClick = function(e) {
            console.log('Button clicked/touched:', btn, e.type);
            e.stopPropagation();
          };
          
          btn.addEventListener('click', handleButtonClick);
          btn.addEventListener('touchend', handleButtonClick);
        });
      }
      
      // Check for backdrop
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        console.log('Backdrop found:', {
          zIndex: window.getComputedStyle(backdrop).zIndex,
          pointerEvents: window.getComputedStyle(backdrop).pointerEvents
        });
        backdrop.style.zIndex = '1050';
        
        // On mobile, ensure backdrop doesn't interfere
        if (isMobile) {
          backdrop.style.touchAction = 'none';
        }
      }
      
      // Mobile-specific: Prevent body scroll when modal is open
      if (isMobile) {
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        
        // Restore on close
        modal.addEventListener('hidden.bs.modal', function() {
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.width = '';
        }, { once: true });
      }
      
      // Re-initialize employee search to ensure event handlers are attached
      initializeEmployeeSearch();
      
      console.log('Form should now be interactive - try clicking on inputs');
    });

    // Setup date change listener
    const payoutDateInput = document.getElementById('payoutDate');
    if (payoutDateInput) {
      payoutDateInput.addEventListener('change', async function() {
        await loadEmployees(this.value);
        // Clear labor costs to force recalculation
        const laborCostsInput = document.getElementById('laborCosts');
        if (laborCostsInput) {
          laborCostsInput.value = '0';
        }
      });
    }
  }

  function togglePayTypeInput(select) {
    const row = select.closest('.employee-payout-row');
    const payType = select.value;
    const percentageGroup = row.querySelector('.percentage-input-group');
    const percentageInput = row.querySelector('.percentage-rate');
    
    if (payType === 'percentage') {
      if (percentageGroup) percentageGroup.style.display = 'block';
      if (percentageInput) percentageInput.required = true;
    } else {
      if (percentageGroup) percentageGroup.style.display = 'none';
      if (percentageInput) percentageInput.required = false;
    }
  }
  
  async function handleDateChange() {
    const date = document.getElementById('payoutDate').value;
    if (date) {
      await loadEmployees(date);
      // Recalculate all payouts after loading employees
      calculatePayout();
    }
  }

  function addEmployeeRow() {
    const container = document.getElementById('employeePayoutsContainer');
    const newRow = document.createElement('div');
    newRow.className = 'employee-payout-row mb-3 p-3 border rounded';
    newRow.setAttribute('data-index', employeeIndex);
    
    newRow.innerHTML = `
      <div class="row g-3">
        <div class="col-md-5">
          <label class="form-label small">Employee</label>
          <div class="employee-search-wrapper" style="position: relative;">
            <input type="text" class="form-control employee-search-input" placeholder="Search employees..." autocomplete="off" required>
            <input type="hidden" class="employee-id-input" name="employeePayouts[${employeeIndex}][employeeId]">
            <div class="employee-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; z-index: 10000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Pay Type</label>
          <select class="form-select pay-type-select" name="employeePayouts[${employeeIndex}][payType]" onchange="togglePayTypeInput(this)" required>
            <option value="percentage">Percentage</option>
            <option value="hourly">Hourly</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Payout Amount</label>
          <div class="payout-amount text-success fw-bold fs-5">$0.00</div>
        </div>
        <div class="col-md-1">
          <label class="form-label small">&nbsp;</label>
          <button type="button" class="btn btn-sm btn-danger w-100 remove-employee" onclick="removeEmployeeRow(this)">
            <i class="bi bi-x"></i> Remove
          </button>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-6 percentage-input-group">
          <label class="form-label small">Percentage Rate</label>
          <div class="input-group">
            <input type="number" class="form-control percentage-rate" name="employeePayouts[${employeeIndex}][percentageRate]" step="0.01" min="0" max="100" placeholder="Enter percentage" onchange="calculatePayout()">
            <span class="input-group-text">%</span>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(newRow);
    
    // Initialize search for new row
    const wrapper = newRow.querySelector('.employee-search-wrapper');
    const searchInput = newRow.querySelector('.employee-search-input');
    const employeeIdInput = newRow.querySelector('.employee-id-input');
    const percentageRateInput = newRow.querySelector('.percentage-rate');
    const payoutAmountSpan = newRow.querySelector('.payout-amount');
    
    if (wrapper && searchInput && employeeIdInput) {
      initEmployeeSearch(wrapper, searchInput, employeeIdInput, percentageRateInput, payoutAmountSpan);
      wrapper.dataset.initialized = 'true';
    }
    
    // Hourly rate and hours are calculated from time entries, no manual input needed
    
    // Add event listener for pay type change
    const payTypeSelect = newRow.querySelector('.pay-type-select');
    if (payTypeSelect) {
      payTypeSelect.addEventListener('change', function() {
        togglePayTypeInput(this);
        calculatePayout();
      });
    }
    
    // Add event listener for percentage rate change
    if (percentageRateInput) {
      percentageRateInput.addEventListener('change', calculatePayout);
      percentageRateInput.addEventListener('input', calculatePayout);
    }
    
    setTimeout(() => searchInput.focus(), 100);
    employeeIndex++;
    
    // Recalculate after adding new row
    setTimeout(() => calculatePayout(), 100);
  }

  function removeEmployeeRow(button) {
    const container = document.getElementById('employeePayoutsContainer');
    if (container.children.length > 1) {
      button.closest('.employee-payout-row').remove();
      calculatePayout();
    }
  }

  async function calculateLaborCosts() {
    const date = document.getElementById('payoutDate').value;
    if (!date) {
      alert('Please select a date first');
      return;
    }

    try {
      const response = await fetch(`/payouts/calculate-form?date=${date}`);
      const data = await response.json();
      
      if (data.success && data.employeesWhoWorked) {
        // Include both labor costs and flat rates
        const totalLaborCost = data.employeesWhoWorked.reduce((sum, emp) => {
          const laborCost = emp.laborCost || 0;
          const flatRate = emp.flatRate || 0;
          // laborCost already includes flat rate if it was set, but we add it explicitly to be sure
          return sum + laborCost;
        }, 0);
        document.getElementById('laborCosts').value = totalLaborCost.toFixed(2);
        calculatePayout();
      }
    } catch (error) {
      console.error('Error calculating labor costs:', error);
      alert('Error calculating labor costs');
    }
  }

  function calculatePayout() {
    const totalRevenue = parseFloat(document.getElementById('totalRevenue').value) || 0;
    const jobCosts = parseFloat(document.getElementById('jobCosts').value) || 0;
    const materials = parseFloat(document.getElementById('materials').value) || 0;
    const date = document.getElementById('payoutDate').value;
    
    // Calculate labor costs from hourly payouts and flat rates
    let laborCosts = 0;
    document.querySelectorAll('.employee-payout-row').forEach(row => {
      const payTypeSelect = row.querySelector('.pay-type-select');
      const payType = payTypeSelect ? payTypeSelect.value : 'percentage';
      const employeeIdInput = row.querySelector('.employee-id-input');
      const employeeId = employeeIdInput ? employeeIdInput.value : null;
      
      if (payType === 'hourly') {
        // Get hourly data from time entries
        if (employeeId && date) {
          let hourlyPayout = 0;
          // Check time entries
          if (timeEntriesByEmployee[employeeId]) {
            const empTimeEntries = timeEntriesByEmployee[employeeId];
            empTimeEntries.forEach(entry => {
              // If flat rate exists, use it; otherwise calculate from hours
              if (entry.flatRate && entry.flatRate > 0) {
                hourlyPayout += entry.flatRate;
              } else {
                // Calculate from hours (need employee data for rate)
                const workedEmployee = employeesWhoWorked.find(e => {
                  const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
                  return eId === employeeId;
                });
                if (workedEmployee && workedEmployee.hourlyRate) {
                  const regularHours = (entry.hoursWorked || 0) - (entry.overtimeHours || 0);
                  const overtimeHours = entry.overtimeHours || 0;
                  const overtimeMultiplier = workedEmployee.defaultOvertimeMultiplier || 1.5;
                  hourlyPayout += (regularHours * workedEmployee.hourlyRate) + 
                                  (overtimeHours * workedEmployee.hourlyRate * overtimeMultiplier);
                }
              }
            });
          }
          // Also check employeesWhoWorked for labor cost
          const workedEmployee = employeesWhoWorked.find(e => {
            const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
            return eId === employeeId;
          });
          if (workedEmployee && workedEmployee.laborCost) {
            hourlyPayout = workedEmployee.laborCost;
          }
          laborCosts += hourlyPayout;
        }
      } else if (payType === 'percentage' && employeeId && date) {
        // For percentage employees, check if they have flat rate for this day
        // Flat rate should be included in labor costs
        if (timeEntriesByEmployee[employeeId]) {
          const empTimeEntries = timeEntriesByEmployee[employeeId];
          const flatRate = empTimeEntries.reduce((sum, entry) => sum + (entry.flatRate || 0), 0);
          if (flatRate > 0) {
            laborCosts += flatRate;
          }
        }
        // Also check employeesWhoWorked for flat rate
        const workedEmployee = employeesWhoWorked.find(e => {
          const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
          return eId === employeeId;
        });
        if (workedEmployee && workedEmployee.flatRate > 0) {
          // Flat rate already included in laborCost, but we add it here to be explicit
          // Actually, let's check if we already added it from time entries
          if (!timeEntriesByEmployee[employeeId] || 
              timeEntriesByEmployee[employeeId].reduce((sum, entry) => sum + (entry.flatRate || 0), 0) === 0) {
            laborCosts += workedEmployee.flatRate;
          }
        }
      }
    });
    
    // Update the labor costs input field
    document.getElementById('laborCosts').value = laborCosts.toFixed(2);
    
    const totalCosts = jobCosts + materials + laborCosts;
    const totalProfit = totalRevenue - totalCosts;

    // Calculate employee payouts
    const rows = document.querySelectorAll('.employee-payout-row');
    let totalEmployeePayout = 0;
    let totalPercentageRate = 0; // Track total percentage for percentage employees

    rows.forEach(row => {
      const payTypeSelect = row.querySelector('.pay-type-select');
      const payType = payTypeSelect ? payTypeSelect.value : 'percentage';
      const employeeIdInput = row.querySelector('.employee-id-input');
      const employeeId = employeeIdInput ? employeeIdInput.value : null;
      let payoutAmount = 0;
      let flatRate = 0;
      
      // Check for flat rate first
      if (employeeId && date) {
        // Check time entries
        if (timeEntriesByEmployee[employeeId]) {
          const empTimeEntries = timeEntriesByEmployee[employeeId];
          flatRate = empTimeEntries.reduce((sum, entry) => sum + (entry.flatRate || 0), 0);
        }
        // Also check employeesWhoWorked
        if (flatRate === 0) {
          const workedEmployee = employeesWhoWorked.find(e => {
            const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
            return eId === employeeId;
          });
          if (workedEmployee && workedEmployee.flatRate > 0) {
            flatRate = workedEmployee.flatRate;
          }
        }
      }
      
      // If flat rate exists, use it (for display purposes)
      // Note: Flat rate is already included in labor costs, so it reduces profit
      // For percentage employees, they still get percentage of profit, but we show flat rate if it exists
      if (flatRate > 0) {
        payoutAmount = flatRate;
      } else if (payType === 'percentage') {
        const percentageRate = parseFloat(row.querySelector('.percentage-rate').value) || 0;
        totalPercentageRate += percentageRate; // Add to total percentage
        payoutAmount = (totalProfit * percentageRate) / 100;
      } else if (payType === 'hourly') {
        // Get hourly payout from time entries (already calculated)
        if (employeeId && date) {
          // Check time entries
          if (timeEntriesByEmployee[employeeId]) {
            const empTimeEntries = timeEntriesByEmployee[employeeId];
            empTimeEntries.forEach(entry => {
              if (entry.flatRate && entry.flatRate > 0) {
                payoutAmount += entry.flatRate;
              } else {
                // Calculate from hours
                const workedEmployee = employeesWhoWorked.find(e => {
                  const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
                  return eId === employeeId;
                });
                if (workedEmployee && workedEmployee.hourlyRate) {
                  const regularHours = (entry.hoursWorked || 0) - (entry.overtimeHours || 0);
                  const overtimeHours = entry.overtimeHours || 0;
                  const overtimeMultiplier = workedEmployee.defaultOvertimeMultiplier || 1.5;
                  payoutAmount += (regularHours * workedEmployee.hourlyRate) + 
                                  (overtimeHours * workedEmployee.hourlyRate * overtimeMultiplier);
                }
              }
            });
          }
          // Also check employeesWhoWorked for labor cost (which includes flat rate)
          const workedEmployee = employeesWhoWorked.find(e => {
            const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
            return eId === employeeId;
          });
          if (workedEmployee && workedEmployee.laborCost && payoutAmount === 0) {
            payoutAmount = workedEmployee.laborCost;
          }
        }
      }
      
      totalEmployeePayout += payoutAmount;
      row.querySelector('.payout-amount').textContent = '$' + payoutAmount.toFixed(2);
    });

    // Update summary
    document.getElementById('summaryRevenue').textContent = '$' + totalRevenue.toFixed(2);
    document.getElementById('summaryJobCosts').textContent = '$' + jobCosts.toFixed(2);
    document.getElementById('summaryMaterials').textContent = '$' + materials.toFixed(2);
    document.getElementById('summaryLaborCosts').textContent = '$' + laborCosts.toFixed(2);
    document.getElementById('summaryCosts').textContent = '$' + totalCosts.toFixed(2);
    document.getElementById('summaryProfit').textContent = '$' + totalProfit.toFixed(2);
    document.getElementById('summaryEmployeePayout').textContent = '$' + totalEmployeePayout.toFixed(2);
    
    // Update the percentage label dynamically to show the actual total percentage
    const percentageLabel = totalPercentageRate > 0 ? `${totalPercentageRate.toFixed(2)}%` : '0%';
    document.getElementById('summaryPercentageLabel').textContent = percentageLabel;
    
    // Show the calculated percentage payout (this represents the percentage-based calculation)
    // This should match the percentage portion of totalEmployeePayout
    const percentageBasedPayout = totalPercentageRate > 0 ? (totalProfit * totalPercentageRate) / 100 : 0;
    document.getElementById('summaryCalculatedPayout').textContent = '$' + percentageBasedPayout.toFixed(2);
  }

  async function savePayout() {
    const form = document.getElementById('payoutForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const formData = {
      date: document.getElementById('payoutDate').value,
      totalRevenue: document.getElementById('totalRevenue').value,
      jobCosts: document.getElementById('jobCosts').value,
      materials: document.getElementById('materials').value,
      laborCosts: document.getElementById('laborCosts').value,
      notes: document.getElementById('payoutNotes').value,
      employeePayouts: []
    };

    // Collect employee payouts
    document.querySelectorAll('.employee-payout-row').forEach(row => {
      const employeeId = row.querySelector('.employee-id-input').value;
      const payTypeSelect = row.querySelector('.pay-type-select');
      const payType = payTypeSelect ? payTypeSelect.value : 'percentage';
      
      if (employeeId) {
        const payoutData = {
          employeeId,
          payType
        };
        
        if (payType === 'percentage') {
          const percentageRate = row.querySelector('.percentage-rate').value;
          if (percentageRate) {
            payoutData.percentageRate = percentageRate;
            formData.employeePayouts.push(payoutData);
          }
        } else if (payType === 'hourly') {
          // Get hourly data from time entries
          const date = document.getElementById('payoutDate').value;
          let hourlyRate = 0;
          let hours = 0;
          
          if (date && employeeId) {
            // Check employeesWhoWorked for hourly rate and hours
            const workedEmployee = employeesWhoWorked.find(e => {
              const eId = e._id ? (typeof e._id === 'object' ? e._id.toString() : String(e._id)) : null;
              return eId === employeeId;
            });
            
            if (workedEmployee) {
              hourlyRate = workedEmployee.hourlyRate || 0;
              hours = workedEmployee.hoursWorked || 0;
            }
            
            // Also check time entries if available
            if (timeEntriesByEmployee[employeeId]) {
              const empTimeEntries = timeEntriesByEmployee[employeeId];
              hours = empTimeEntries.reduce((sum, entry) => sum + (entry.hoursWorked || 0), 0);
              if (!hourlyRate && workedEmployee) {
                hourlyRate = workedEmployee.hourlyRate || 0;
              }
            }
          }
          
          if (hourlyRate > 0 && hours > 0) {
            payoutData.hourlyRate = hourlyRate;
            payoutData.hours = hours;
            formData.employeePayouts.push(payoutData);
            console.log('[Payout Form] Added hourly payout:', payoutData);
          } else {
            // Still add it even if we can't calculate - the backend will handle it
            formData.employeePayouts.push(payoutData);
            console.log('[Payout Form] Added hourly payout (will be calculated from time entries):', payoutData);
          }
        }
      }
    });

    if (formData.employeePayouts.length === 0) {
      alert('Please add at least one employee');
      return;
    }

    console.log('[Payout Form] ===== SUBMITTING PAYOUT =====');
    console.log('[Payout Form] Form data:', JSON.stringify(formData, null, 2));
    console.log('[Payout Form] Employee payouts count:', formData.employeePayouts.length);
    formData.employeePayouts.forEach((ep, idx) => {
      console.log(`[Payout Form] Employee payout ${idx + 1}:`, {
        employeeId: ep.employeeId,
        payType: ep.payType,
        hourlyRate: ep.hourlyRate,
        hours: ep.hours,
        percentageRate: ep.percentageRate
      });
    });

    try {
      const response = await fetch('/payouts/calculate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      console.log('[Payout Form] Response status:', response.status);
      
      const data = await response.json();
      console.log('[Payout Form] Response data:', data);
      
      if (data.success) {
        console.log('[Payout Form] ✓ Payout saved successfully, reloading page...');
        alert('Payout saved successfully!');
        location.reload();
      } else {
        console.error('[Payout Form] ✗ Save failed:', data.error);
        alert('Error: ' + (data.error || 'Failed to save payout'));
      }
    } catch (error) {
      console.error('[Payout Form] ✗ Network/parsing error:', error);
      alert('Error saving payout: ' + error.message);
    }
  }

  // Watch for modal being moved and ensure it stays at body level
  function watchModalPosition() {
    const modal = document.getElementById('calculatePayoutModal');
    if (!modal) return;
    
    const observer = new MutationObserver(function(mutations) {
      if (modal.parentElement !== document.body) {
        console.log('Modal was moved! Moving it back to body...');
        ensureModalAtBodyLevel();
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Also check periodically
    setInterval(() => {
      if (modal && modal.parentElement !== document.body) {
        console.log('Periodic check: Modal not at body level, fixing...');
        ensureModalAtBodyLevel();
      }
    }, 500);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up modal listener...');
    ensureModalAtBodyLevel();
    setupModalListener();
    initializeEmployeeSearch();
    watchModalPosition();
    
    // Add event listeners to initial form fields
    const totalRevenue = document.getElementById('totalRevenue');
    const jobCosts = document.getElementById('jobCosts');
    const materials = document.getElementById('materials');
    
    if (totalRevenue) {
      totalRevenue.addEventListener('input', calculatePayout);
      totalRevenue.addEventListener('change', calculatePayout);
    }
    if (jobCosts) {
      jobCosts.addEventListener('input', calculatePayout);
      jobCosts.addEventListener('change', calculatePayout);
    }
    if (materials) {
      materials.addEventListener('input', calculatePayout);
      materials.addEventListener('change', calculatePayout);
    }
    
    // Add event listeners to initial employee row
    const firstRow = document.querySelector('.employee-payout-row');
    if (firstRow) {
      const payTypeSelect = firstRow.querySelector('.pay-type-select');
      const percentageRateInput = firstRow.querySelector('.percentage-rate');
      
      if (payTypeSelect) {
        payTypeSelect.addEventListener('change', function() {
          togglePayTypeInput(this);
          calculatePayout();
        });
      }
      if (percentageRateInput) {
        percentageRateInput.addEventListener('input', calculatePayout);
        percentageRateInput.addEventListener('change', calculatePayout);
      }
    }
    
    // Add click test to modal
    const modal = document.getElementById('calculatePayoutModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        console.log('Modal clicked:', e.target, e.currentTarget);
      }, true);
    }
  });

  // Also try to setup immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    // DOM is still loading, wait for DOMContentLoaded
  } else {
    // DOM is already loaded
    console.log('DOM already loaded, setting up modal listener immediately...');
    setTimeout(() => {
      ensureModalAtBodyLevel();
      setupModalListener();
      initializeEmployeeSearch();
      watchModalPosition();
    }, 100);
  }
</script>

<style>
  .employee-option:hover {
    background-color: #f8f9fa;
  }
  
  /* Mobile: Hide button text, show only icons */
  @media (max-width: 768px) {
    /* Target buttons in the header action area */
    .employee-action-buttons .btn {
      padding: 0.375rem !important;
      min-width: 40px;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    /* Hide text spans on mobile */
    .employee-action-buttons .btn .btn-text {
      display: none;
    }
    
    /* Ensure icons are centered and visible */
    .employee-action-buttons .btn > i {
      margin: 0 !important;
      font-size: 1.1rem;
      line-height: 1;
    }
    
    /* Ensure icon-only buttons have proper spacing */
    .employee-action-buttons {
      gap: 0.5rem !important;
      flex-wrap: wrap;
    }
    
    /* Make the header more compact on mobile */
    .container-fluid > .d-flex.justify-content-between {
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .container-fluid > .d-flex.justify-content-between > h1 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      width: 100%;
    }
    
    .container-fluid > .d-flex.justify-content-between > .employee-action-buttons {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>
</script>

<%- include('../partials/footer') %>

