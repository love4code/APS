<%- include('../partials/header', { title: 'Employees' }) %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Employees</h1>
    <a href="/employees/new" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> New Employee
    </a>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="/employees" class="row g-3">
        <div class="col-md-4">
          <input
            type="text"
            class="form-control"
            name="search"
            placeholder="Search by name or email..."
            value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          />
        </div>
        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="">All Statuses</option>
            <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
            <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Inactive</option>
            <option value="terminated" <%= statusFilter === 'terminated' ? 'selected' : '' %>>Terminated</option>
            <option value="on_leave" <%= statusFilter === 'on_leave' ? 'selected' : '' %>>On Leave</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="department">
            <option value="">All Departments</option>
            <% if (typeof departments !== 'undefined' && departments) { %>
              <% departments.forEach(dept => { %>
                <option value="<%= dept %>" <%= departmentFilter === dept ? 'selected' : '' %>><%= dept %></option>
              <% }) %>
            <% } %>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Position</th>
          <th>Department</th>
          <th>Status</th>
          <th>Pay Type</th>
          <th>Rate/Salary</th>
          <th>Hire Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (employees && employees.length > 0) { %>
          <% employees.forEach(employee => { %>
            <tr>
              <td>
                <a href="/employees/<%= employee._id %>" class="text-decoration-none">
                  <%= employee.firstName %> <%= employee.lastName %>
                </a>
              </td>
              <td><%= employee.position %></td>
              <td><%= employee.department %></td>
              <td>
                <% 
                  let statusClass = 'secondary';
                  if (employee.status === 'active') statusClass = 'success';
                  else if (employee.status === 'terminated') statusClass = 'danger';
                  else if (employee.status === 'on_leave') statusClass = 'warning';
                %>
                <span class="badge bg-<%= statusClass %>"><%= employee.status %></span>
              </td>
              <td>
                <% 
                  const payTypes = Array.isArray(employee.payType) ? employee.payType : [employee.payType];
                  const payTypeLabels = payTypes.map(pt => {
                    if (pt === 'hourly') return 'Hourly';
                    if (pt === 'salary') return 'Salary';
                    if (pt === 'percentage') return 'Percentage';
                    return pt;
                  });
                %>
                <%= payTypeLabels.join(', ') %>
              </td>
              <td>
                <% 
                  let rateDisplay = [];
                  if (payTypes.includes('hourly')) {
                    rateDisplay.push('$' + (employee.hourlyRate || 0).toFixed(2) + '/hr');
                  }
                  if (payTypes.includes('salary')) {
                    rateDisplay.push('$' + ((employee.annualSalary || 0) / 52).toFixed(2) + '/wk');
                  }
                  if (payTypes.includes('percentage')) {
                    rateDisplay.push((employee.percentageRate || 0).toFixed(2) + '%');
                  }
                %>
                <%= rateDisplay.length > 0 ? rateDisplay.join(', ') : 'N/A' %>
              </td>
              <td>
                <%= employee.hireDate ? (() => { const d = new Date(employee.hireDate); return (d.getUTCMonth() + 1) + '/' + d.getUTCDate() + '/' + d.getUTCFullYear(); })() : '-' %>
              </td>
              <td>
                <a href="/employees/<%= employee._id %>" class="btn btn-sm btn-outline-primary">View</a>
                <a href="/employees/<%= employee._id %>/edit" class="btn btn-sm btn-outline-secondary">Edit</a>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="8" class="text-center text-muted">No employees found</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <% if (currentPage > 1) { %>
          <li class="page-item">
            <a class="page-link" href="?page=<%= currentPage - 1 %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %><%= statusFilter ? '&status=' + statusFilter : '' %><%= departmentFilter ? '&department=' + departmentFilter : '' %>">Previous</a>
          </li>
        <% } %>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= i === currentPage ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %><%= statusFilter ? '&status=' + statusFilter : '' %><%= departmentFilter ? '&department=' + departmentFilter : '' %>"><%= i %></a>
          </li>
        <% } %>
        <% if (currentPage < totalPages) { %>
          <li class="page-item">
            <a class="page-link" href="?page=<%= currentPage + 1 %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %><%= statusFilter ? '&status=' + statusFilter : '' %><%= departmentFilter ? '&department=' + departmentFilter : '' %>">Next</a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('../partials/footer') %>

