<%- include('../partials/header', { title: job ? 'Edit Job' : 'New Job' }) %>

<style>
  .product-search-wrapper {
    position: relative;
    z-index: 1000;
  }
  .product-dropdown {
    position: absolute;
    z-index: 10000;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    margin-top: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .item-row {
    position: relative;
    z-index: 1;
  }
  .item-row:hover {
    z-index: 1000;
  }
  .product-option {
    cursor: pointer;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
  }
  .product-option:hover {
    background-color: #f8f9fa;
  }
  .product-option:last-child {
    border-bottom: none;
  }
  .product-option .badge {
    font-size: 0.7rem;
    margin-left: 8px;
  }
  /* Ensure modals appear above all content, including product dropdowns */
  /* Product dropdown has z-index 10000, so we need modal higher than that */
  /* Bootstrap default: backdrop z-index 1040, modal z-index 1055 */
  .modal {
    z-index: 10050 !important;
  }
  .modal-backdrop {
    z-index: 10040 !important;
  }
  .modal-dialog {
    z-index: 10051 !important;
    position: relative;
  }
  .modal-content {
    z-index: 10052 !important;
    position: relative;
  }
  /* Ensure product dropdown closes when modal opens */
  body.modal-open .product-dropdown {
    display: none !important;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-10 mx-auto">
      <h1 class="h3 mb-4"><%= job ? 'Edit Job' : 'New Job' %></h1>

      <form method="POST" action="<%= job ? `/jobs/${job._id}` : '/jobs' %>" id="jobForm">
        <% if (typeof selectedCustomer !== 'undefined' && selectedCustomer && selectedCustomer._id) { %>
        <input type="hidden" name="customerId" value="<%= selectedCustomer._id.toString() %>">
        <% } else if (typeof customerId !== 'undefined' && customerId) { %>
        <input type="hidden" name="customerId" value="<%= customerId %>">
        <% } %>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="customer" class="form-label">Customer *</label>
            <div class="input-group">
              <select class="form-select" id="customer" name="customer" required>
                <option value="">Select customer...</option>
                <% customers.forEach(c => { %>
                  <option value="<%= c._id %>" <%= (job && job.customer && (typeof job.customer === 'object' ? job.customer._id.toString() : job.customer.toString()) === c._id.toString()) || (typeof selectedCustomer !== 'undefined' && selectedCustomer && selectedCustomer._id && selectedCustomer._id.toString() === c._id.toString()) || (typeof customerId !== 'undefined' && customerId && customerId.toString() === c._id.toString()) ? 'selected' : '' %>>
                    <%= c.name %>
                  </option>
                <% }) %>
              </select>
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCustomerModal" title="Add New Customer">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
            <% if ((typeof selectedCustomer !== 'undefined' && selectedCustomer) || (typeof customerId !== 'undefined' && customerId)) { %>
            <small class="form-text text-muted">Pre-selected from customer page</small>
            <% } %>
          </div>

          <div class="col-md-6 mb-3">
            <label for="installer" class="form-label">Installer</label>
            <select class="form-select" id="installer" name="installer">
              <option value="">Not assigned</option>
              <% installers.forEach(i => { %>
                <option value="<%= i._id %>" <%= job && job.installer && job.installer.toString() === i._id.toString() ? 'selected' : '' %>>
                  <%= i.name %>
                </option>
              <% }) %>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="salesRep" class="form-label">Sales Rep</label>
            <select class="form-select" id="salesRep" name="salesRep">
              <option value="">Not assigned</option>
              <% salesReps.forEach(rep => { %>
                <option value="<%= rep._id %>" <%= job && job.salesRep && job.salesRep.toString() === rep._id.toString() ? 'selected' : '' %>>
                  <%= rep.name %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="soldByOwner" name="soldByOwner" <%= job && job.soldByOwner ? 'checked' : '' %>>
              <label class="form-check-label" for="soldByOwner">Sold by Owner</label>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="store" class="form-label">Store</label>
            <select class="form-select" id="store" name="store">
              <option value="">No store selected</option>
              <% if (stores && stores.length > 0) { %>
                <% stores.forEach(s => { %>
                  <option value="<%= s._id %>" <%= job && job.store && job.store.toString() === s._id.toString() ? 'selected' : '' %>>
                    <%= s.name %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <small class="form-text text-muted">
              <a href="/stores/new" target="_blank">Add new store</a>
            </small>
          </div>

          <div class="col-md-6 mb-3">
            <label for="installDate" class="form-label">Install Date</label>
            <div class="input-group">
              <input type="date" class="form-control" id="installDate" name="installDate" value="<%= job && job.installDate ? new Date(job.installDate).toISOString().split('T')[0] : '' %>">
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#calendarModal" title="View Calendar">
                <i class="bi bi-calendar3"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="orderDate" class="form-label">Pool Order Date</label>
            <input type="date" class="form-control" id="orderDate" name="orderDate" value="<%= job && job.orderDate ? new Date(job.orderDate).toISOString().split('T')[0] : '' %>">
            <small class="form-text text-muted">Date when pool was ordered</small>
          </div>

          <div class="col-md-6 mb-3">
            <label for="deliveryDate" class="form-label">Pool Delivery Date</label>
            <input type="date" class="form-control" id="deliveryDate" name="deliveryDate" value="<%= job && job.deliveryDate ? new Date(job.deliveryDate).toISOString().split('T')[0] : '' %>">
            <small class="form-text text-muted">Date when pool was delivered</small>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="invoicedDate" class="form-label">Invoiced Date</label>
            <input type="date" class="form-control" id="invoicedDate" name="invoicedDate" value="<%= job && typeof job.invoicedDate !== 'undefined' && job.invoicedDate ? new Date(job.invoicedDate).toISOString().split('T')[0] : '' %>">
            <small class="form-text text-muted">Date when invoice was created</small>
          </div>

          <div class="col-md-6 mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="scheduled" <%= job && job.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
              <option value="complete" <%= job && job.status === 'complete' ? 'selected' : '' %>>Complete</option>
              <option value="delivered" <%= job && job.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
              <option value="undelivered" <%= job && job.status === 'undelivered' ? 'selected' : '' %>>Undelivered</option>
              <option value="delayed" <%= job && job.status === 'delayed' ? 'selected' : '' %>>Delayed</option>
            </select>
          </div>
        </div>

        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Items</h5>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#newProductModal">
                <i class="bi bi-plus-circle"></i> New Product/Service
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm" id="add-item-btn">
                <i class="bi bi-plus-circle"></i> Add Item
              </button>
            </div>
          </div>
          <div id="items-container">
            <% if (job && job.items && job.items.length > 0) { %>
              <% job.items.forEach((item, index) => { %>
                <div class="card mb-2 item-row" data-index="<%= index %>">
                  <div class="card-body">
                    <div class="row align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">Product/Service</label>
                        <div class="product-search-wrapper" data-index="<%= index %>">
                          <div class="input-group">
                            <select class="form-select form-select-sm product-type-filter" style="max-width: 100px;" title="Filter by type">
                              <option value="all">All</option>
                              <option value="product">Products</option>
                              <option value="service">Services</option>
                            </select>
                            <input type="text" class="form-control product-search-input" placeholder="Search products/services..." autocomplete="off" data-selected-id="<%= item.product ? item.product._id.toString() : '' %>" data-selected-name="<%= item.product ? item.product.name : '' %>" value="<%= item.product ? item.product.name + ' - $' + item.unitPrice.toFixed(2) : '' %>">
                            <input type="hidden" class="product-id-input" name="items[<%= index %>][productId]" value="<%= item.product ? item.product._id.toString() : '' %>" required>
                            <div class="product-dropdown" style="display: none;"></div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control quantity-input" name="items[<%= index %>][quantity]" value="<%= item.quantity %>" min="1" required>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">Unit Price</label>
                        <input type="number" class="form-control price-input" name="items[<%= index %>][unitPrice]" value="<%= item.unitPrice %>" step="0.01" min="0" required>
                      </div>
                      <div class="col-md-2">
                        <div class="form-check mt-4">
                          <input class="form-check-input taxable-checkbox" type="checkbox" name="items[<%= index %>][isTaxable]" <%= item.isTaxable ? 'checked' : '' %>>
                          <label class="form-check-label">Taxable</label>
                        </div>
                      </div>
                      <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm remove-item" title="Remove this item">
                          <i class="bi bi-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted" id="no-items-message">No items added yet. Click "Add Item" above to add products or services.</p>
            <% } %>
          </div>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Customer-Facing Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Notes that will appear on invoices"><%= job ? job.notes : '' %></textarea>
          <small class="form-text text-muted">These notes will appear on invoices and the job detail page.</small>
        </div>

        <div class="mb-3">
          <label for="internalNotes" class="form-label">Internal Job Notes</label>
          <textarea class="form-control" id="internalNotes" name="internalNotes" rows="4" placeholder="Internal notes for your records only"><%= job ? job.internalNotes : '' %></textarea>
          <small class="form-text text-muted">These notes are for internal use only and will NOT appear on invoices or be visible to customers.</small>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save Job</button>
          <a href="<%= job ? `/jobs/${job._id}` : '/jobs' %>" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>
    </div>
  </div>
</div>

<!-- New Product/Service Modal -->
<div class="modal fade" id="newProductModal" tabindex="-1" aria-labelledby="newProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newProductModalLabel">New Product/Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="newProductForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="productName" class="form-label">Name *</label>
            <input type="text" class="form-control" id="productName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="productDescription" class="form-label">Description</label>
            <textarea class="form-control" id="productDescription" name="description" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="productBasePrice" class="form-label">Base Price *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="productBasePrice" name="basePrice" step="0.01" min="0" required>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="productType" class="form-label">Type *</label>
              <select class="form-select" id="productType" name="type" required>
                <option value="">Select...</option>
                <option value="product">Product</option>
                <option value="service">Service</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="productIsTaxable" name="isTaxable" checked>
              <label class="form-check-label" for="productIsTaxable">Taxable (6.25% tax will be applied)</label>
            </div>
          </div>
          <div id="productFormError" class="alert alert-danger d-none" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span id="productSubmitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Create & Add to Job
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let itemIndex = <%= job && job.items ? job.items.length : 0 %>;
  let products = <%- JSON.stringify(products) %>;

  function addItemRow() {
    const container = document.getElementById('items-container');
    
    // Remove "no items" message if it exists
    const noItemsMsg = container.querySelector('#no-items-message');
    if (noItemsMsg) {
      noItemsMsg.remove();
    }
    
    const itemRow = document.createElement('div');
    itemRow.className = 'card mb-2 item-row';
    itemRow.setAttribute('data-index', itemIndex);
    
    itemRow.innerHTML = 
      '<div class="card-body">' +
        '<div class="row align-items-end">' +
          '<div class="col-md-4">' +
            '<label class="form-label">Product/Service</label>' +
            '<div class="product-search-wrapper" data-index="' + itemIndex + '">' +
              '<div class="input-group">' +
                '<select class="form-select form-select-sm product-type-filter" style="max-width: 100px;" title="Filter by type">' +
                  '<option value="all">All</option>' +
                  '<option value="product">Products</option>' +
                  '<option value="service">Services</option>' +
                '</select>' +
                '<input type="text" class="form-control product-search-input" placeholder="Search products/services..." autocomplete="off">' +
                '<input type="hidden" class="product-id-input" name="items[' + itemIndex + '][productId]" required>' +
                '<div class="product-dropdown" style="display: none;"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="col-md-2">' +
            '<label class="form-label">Quantity</label>' +
            '<input type="number" class="form-control quantity-input" name="items[' + itemIndex + '][quantity]" value="1" min="1" required>' +
          '</div>' +
          '<div class="col-md-2">' +
            '<label class="form-label">Unit Price</label>' +
            '<input type="number" class="form-control price-input" name="items[' + itemIndex + '][unitPrice]" step="0.01" min="0" required>' +
          '</div>' +
          '<div class="col-md-2">' +
            '<div class="form-check mt-4">' +
              '<input class="form-check-input taxable-checkbox" type="checkbox" name="items[' + itemIndex + '][isTaxable]" checked>' +
              '<label class="form-check-label">Taxable</label>' +
            '</div>' +
          '</div>' +
          '<div class="col-md-2">' +
            '<button type="button" class="btn btn-danger btn-sm remove-item" title="Remove this item">' +
              '<i class="bi bi-trash"></i> Remove' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    container.appendChild(itemRow);
    itemIndex++;

    // Add event listeners to new row
    const searchWrapper = itemRow.querySelector('.product-search-wrapper');
    const searchInput = itemRow.querySelector('.product-search-input');
    const productIdInput = itemRow.querySelector('.product-id-input');
    const typeFilter = itemRow.querySelector('.product-type-filter');
    const dropdown = itemRow.querySelector('.product-dropdown');
    const priceInput = itemRow.querySelector('.price-input');
    const taxableCheckbox = itemRow.querySelector('.taxable-checkbox');
    
    // Initialize search functionality for this row
    initProductSearch(searchWrapper, searchInput, productIdInput, typeFilter, dropdown, priceInput, taxableCheckbox);

    itemRow.querySelector('.remove-item').addEventListener('click', function() {
      itemRow.remove();
      // Show "no items" message if no items remain
      if (container.querySelectorAll('.item-row').length === 0) {
        const noItemsMsg = document.createElement('p');
        noItemsMsg.className = 'text-muted';
        noItemsMsg.id = 'no-items-message';
        noItemsMsg.textContent = 'No items added yet. Click "Add Item" below.';
        container.appendChild(noItemsMsg);
      }
    });
    
    // Visual feedback: highlight the new row and scroll to it
    itemRow.style.transition = 'all 0.3s ease';
    itemRow.style.backgroundColor = '#d4edda'; // Light green background
    itemRow.style.border = '2px solid #28a745'; // Green border
    
    // Scroll to the new item smoothly
    itemRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Remove highlight after 2 seconds
    setTimeout(function() {
      itemRow.style.backgroundColor = '';
      itemRow.style.border = '';
    }, 2000);
    
    // Focus on the search input for better UX
    setTimeout(function() {
      searchInput.focus();
    }, 100);
  }

  // Product search functionality
  function initProductSearch(wrapper, searchInput, productIdInput, typeFilter, dropdown, priceInput, taxableCheckbox) {
    let selectedProduct = null;
    
    function filterProducts() {
      if (!searchInput || !dropdown || !products) {
        return;
      }
      
      const searchTerm = searchInput.value.toLowerCase().trim();
      const typeFilterValue = typeFilter ? typeFilter.value : 'all';
      
      // Filter products based on search term and type
      const filtered = products.filter(p => {
        const matchesSearch = searchTerm.length === 0 || p.name.toLowerCase().includes(searchTerm);
        const matchesType = typeFilterValue === 'all' || p.type === typeFilterValue;
        return matchesSearch && matchesType;
      });
      
      // Show dropdown if there are results (or if input is empty, show all filtered by type)
      if (filtered.length > 0) {
        dropdown.style.display = 'block';
        dropdown.innerHTML = filtered.map(p => {
          const typeBadge = p.type === 'product' ? '<span class="badge bg-primary">Product</span>' : '<span class="badge bg-info">Service</span>';
          return `<div class="product-option p-2 border-bottom" style="cursor: pointer;" data-id="${p._id}" data-price="${p.basePrice}" data-taxable="${p.isTaxable}" data-name="${p.name}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${p.name}</strong> ${typeBadge}
              </div>
              <div class="text-muted">$${p.basePrice.toFixed(2)}</div>
            </div>
          </div>`;
        }).join('');
        
        // Position dropdown using absolute positioning relative to wrapper
        dropdown.style.position = 'absolute';
        dropdown.style.top = '100%';
        dropdown.style.left = '0';
        dropdown.style.width = '100%';
        dropdown.style.zIndex = '10000';
        dropdown.style.display = 'block'; // Ensure it's visible
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    // Search input event - show suggestions as user types
    searchInput.addEventListener('input', filterProducts);
    
    // Show suggestions on focus
    searchInput.addEventListener('focus', function() {
      filterProducts();
    });
    
    // Don't close dropdown on blur - let click handler manage it
    searchInput.addEventListener('blur', function(e) {
      // Don't close if clicking on dropdown or items container
      const relatedTarget = e.relatedTarget;
      if (relatedTarget && (dropdown.contains(relatedTarget) || (itemsContainer && itemsContainer.contains(relatedTarget)))) {
        // Keep focus on input to prevent closing
        setTimeout(function() {
          searchInput.focus();
        }, 0);
      }
    });
    
    // Type filter change
    typeFilter.addEventListener('change', function() {
      filterProducts();
    });
    
    // Dropdown option click
    dropdown.addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent event from bubbling to document
      const option = e.target.closest('.product-option');
      if (option) {
        const productId = option.getAttribute('data-id');
        const productName = option.getAttribute('data-name');
        const price = option.getAttribute('data-price');
        const taxable = option.getAttribute('data-taxable') === 'true';
        
        // Find the product object
        selectedProduct = products.find(p => p._id === productId);
        
        // Update inputs
        productIdInput.value = productId;
        searchInput.value = productName + ' - $' + parseFloat(price).toFixed(2);
        priceInput.value = price;
        taxableCheckbox.checked = taxable;
        
        // Hide dropdown
        dropdown.style.display = 'none';
      }
    });
    
    // Prevent dropdown from closing when interacting with it
    // Prevent dropdown from closing when interacting with it
    dropdown.addEventListener('mousedown', function(e) {
      e.stopPropagation();
    });
    
    dropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    
    // Get the item row and items container
    const itemRow = wrapper.closest('.item-row');
    const itemsContainer = document.getElementById('items-container');
    
    // Close dropdown when clicking outside - use a more robust check
    const closeDropdownOnOutsideClick = function(e) {
      // Skip if dropdown is already hidden
      if (dropdown.style.display === 'none') {
        return;
      }
      
      // Get the element that was clicked
      const target = e.target;
      
      // Don't close if clicking on:
      // 1. The dropdown itself or any of its children
      if (dropdown.contains(target)) {
        return;
      }
      
      // 2. The search input or wrapper
      if (wrapper.contains(target)) {
        return;
      }
      
      // 3. The item row containing this input
      if (itemRow && itemRow.contains(target)) {
        return;
      }
      
      // 4. Anywhere in the items container
      if (itemsContainer && itemsContainer.contains(target)) {
        return;
      }
      
      // Only close if clicking completely outside all these areas
      dropdown.style.display = 'none';
    };
    
    // Track if we should prevent closing (when mouse is moving)
    let preventClose = false;
    
    // Prevent closing when mouse enters dropdown or items container
    dropdown.addEventListener('mouseenter', function() {
      preventClose = true;
    });
    
    if (itemsContainer) {
      itemsContainer.addEventListener('mouseenter', function() {
        preventClose = true;
      });
      itemsContainer.addEventListener('mouseleave', function() {
        preventClose = false;
      });
    }
    
    dropdown.addEventListener('mouseleave', function() {
      // Small delay to allow mouse to move back
      setTimeout(function() {
        preventClose = false;
      }, 100);
    });
    
    // Track mouse position to prevent closing when over safe areas
    let mouseOverSafeArea = false;
    
    // Mark safe area when mouse enters
    if (itemsContainer) {
      itemsContainer.addEventListener('mouseenter', function() {
        mouseOverSafeArea = true;
      });
      itemsContainer.addEventListener('mouseleave', function() {
        mouseOverSafeArea = false;
      });
    }
    
    dropdown.addEventListener('mouseenter', function() {
      mouseOverSafeArea = true;
    });
    
    dropdown.addEventListener('mouseleave', function(e) {
      // Check if mouse moved to items container
      setTimeout(function() {
        const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
        if (!itemsContainer || !itemsContainer.contains(elementUnderMouse)) {
          mouseOverSafeArea = false;
        }
      }, 50);
    });
    
    // Modified close handler that checks mouse position
    const safeCloseHandler = function(e) {
      // Don't close if mouse is over safe area
      if (mouseOverSafeArea || preventClose) {
        return;
      }
      closeDropdownOnOutsideClick(e);
    };
    
    // Use click event in bubble phase - only fires on actual clicks, not mouse movement
    document.addEventListener('click', safeCloseHandler, false);
    
    // Handle existing selected product (for edit mode)
    if (searchInput.getAttribute('data-selected-id')) {
      const selectedId = searchInput.getAttribute('data-selected-id');
      const selectedName = searchInput.getAttribute('data-selected-name');
      const selectedProd = products.find(p => p._id === selectedId);
      if (selectedProd) {
        productIdInput.value = selectedId;
        priceInput.value = selectedProd.basePrice;
        taxableCheckbox.checked = selectedProd.isTaxable;
      }
    }
  }

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Add item button
    const addItemBtn = document.getElementById('add-item-btn');
    if (addItemBtn) {
      addItemBtn.addEventListener('click', function(e) {
        e.preventDefault();
        addItemRow();
      });
    } else {
      console.error('Add item button not found!');
    }

    // Initialize product search for existing rows
    document.querySelectorAll('.product-search-wrapper').forEach(wrapper => {
      const searchInput = wrapper.querySelector('.product-search-input');
      const productIdInput = wrapper.querySelector('.product-id-input');
      const typeFilter = wrapper.querySelector('.product-type-filter');
      const dropdown = wrapper.querySelector('.product-dropdown');
      const row = wrapper.closest('.item-row');
      const priceInput = row.querySelector('.price-input');
      const taxableCheckbox = row.querySelector('.taxable-checkbox');
      
      initProductSearch(wrapper, searchInput, productIdInput, typeFilter, dropdown, priceInput, taxableCheckbox);
    });

    // Remove item buttons
    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const container = document.getElementById('items-container');
        this.closest('.item-row').remove();
        // Show "no items" message if no items remain
        if (container.querySelectorAll('.item-row').length === 0) {
          const noItemsMsg = document.createElement('p');
          noItemsMsg.className = 'text-muted';
          noItemsMsg.id = 'no-items-message';
          noItemsMsg.textContent = 'No items added yet. Click "Add Item" below.';
          container.appendChild(noItemsMsg);
        }
      });
    });
  });

  // Also try immediately in case DOM is already loaded (for scripts at end of body)
  if (document.readyState === 'loading') {
    // DOM hasn't finished loading yet, wait for DOMContentLoaded
  } else {
    // DOM is already loaded, attach listeners immediately
    const addItemBtn = document.getElementById('add-item-btn');
    if (addItemBtn) {
      addItemBtn.addEventListener('click', function(e) {
        e.preventDefault();
        addItemRow();
      });
    }

    // Product search is initialized above, no need for select listeners

    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const container = document.getElementById('items-container');
        this.closest('.item-row').remove();
        if (container.querySelectorAll('.item-row').length === 0) {
          const noItemsMsg = document.createElement('p');
          noItemsMsg.className = 'text-muted';
          noItemsMsg.id = 'no-items-message';
          noItemsMsg.textContent = 'No items added yet. Click "Add Item" below.';
          container.appendChild(noItemsMsg);
        }
      });
    });
  }

  // Handle new product form submission
  document.getElementById('newProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = document.getElementById('productSubmitSpinner');
    const errorDiv = document.getElementById('productFormError');
    
    // Hide previous errors
    errorDiv.classList.add('d-none');
    errorDiv.textContent = '';
    
    // Show loading state
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    // Get form data
    const formData = new FormData(form);
    const data = {
      name: formData.get('name'),
      description: formData.get('description') || '',
      basePrice: parseFloat(formData.get('basePrice')),
      type: formData.get('type'),
      isTaxable: formData.get('isTaxable') === 'on' ? 'true' : 'false'
    };
    
    try {
      const response = await fetch('/products', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error creating product');
      }
      
      // Add new product to products array
      products.push(result.product);
      
      // Note: New products will appear in search results automatically
      
      // Close modal and reset form
      const modal = bootstrap.Modal.getInstance(document.getElementById('newProductModal'));
      modal.hide();
      form.reset();
      
      // Show success message
      const successAlert = document.createElement('div');
      successAlert.className = 'alert alert-success alert-dismissible fade show';
      successAlert.innerHTML = '<strong>Success!</strong> Product "' + result.product.name + '" created and added to dropdown.';
      successAlert.innerHTML += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
      document.querySelector('.container-fluid').insertBefore(successAlert, document.querySelector('.container-fluid').firstChild);
      
      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        successAlert.remove();
      }, 3000);
      
    } catch (error) {
      errorDiv.textContent = error.message || 'Error creating product. Please try again.';
      errorDiv.classList.remove('d-none');
    } finally {
      submitBtn.disabled = false;
      spinner.classList.add('d-none');
    }
  });
  
  // Reset modal form when closed
  document.getElementById('newProductModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('newProductForm').reset();
    document.getElementById('productFormError').classList.add('d-none');
  });

  // Handle new customer form submission
  let customerFormHandlerAttached = false;
  
  function attachCustomerFormHandler() {
    if (customerFormHandlerAttached) {
      console.log('Customer form handler already attached');
      return true;
    }
    
    const customerForm = document.getElementById('newCustomerForm');
    if (!customerForm) {
      console.warn('Customer form not found');
      return false;
    }
    
    console.log('Attaching customer form handler to form:', customerForm);
    customerFormHandlerAttached = true;
    
    customerForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log('Customer form submit event fired');
      
      const form = this;
      const submitBtn = form.querySelector('button[type="submit"]');
      const spinner = document.getElementById('customerSubmitSpinner');
      const errorDiv = document.getElementById('customerFormError');
      const customerSelect = document.getElementById('customer');
      
      if (!customerSelect) {
        errorDiv.textContent = 'Customer select element not found. Please refresh the page.';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
        return;
      }
      
      // Hide previous errors
      errorDiv.classList.add('d-none');
      errorDiv.textContent = '';
      
      // Show loading state
      submitBtn.disabled = true;
      spinner.classList.remove('d-none');
      
      // Get form data
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        phone: formData.get('phone') || '',
        email: formData.get('email') || '',
        address: formData.get('address') || '',
        notes: formData.get('notes') || ''
      };
      
      // Validate name
      if (!data.name || data.name.trim() === '') {
        errorDiv.textContent = 'Customer name is required';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
        return;
      }
      
      try {
        console.log('Sending customer creation request:', data);
        const response = await fetch('/customers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        console.log('Response received, status:', response.status);
      
      // Check if response is JSON
      const contentType = response.headers.get('content-type');
      let result;
      
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        
        if (response.status === 401 || response.status === 403) {
          throw new Error('Authentication required. Please refresh the page and try again.');
        } else if (response.status === 302 || response.status === 301) {
          throw new Error('Session expired. Please refresh the page and try again.');
        } else {
          throw new Error('Server returned an unexpected response. Please try again.');
        }
      } else {
        result = await response.json();
        console.log('Response JSON:', result);
      }
      
      if (!response.ok) {
        console.error('Response not OK:', response.status, result);
        throw new Error(result.error || 'Error creating customer');
      }
      
      if (!result.customer || !result.customer._id) {
        console.error('Invalid response - missing customer data:', result);
        throw new Error('Invalid response from server - customer data missing');
      }
      
      console.log('Customer created successfully:', result.customer);
      
      // Get customer ID as string to ensure proper matching
      const customerId = String(result.customer._id);
      
      // Add new customer to select dropdown
      const option = document.createElement('option');
      option.value = customerId;
      option.textContent = result.customer.name;
      customerSelect.appendChild(option);
      
      // Set the select value explicitly
      customerSelect.value = customerId;
      
      // Also set selected attribute on the option
      option.selected = true;
      
      // Trigger change event to ensure any listeners are notified
      customerSelect.dispatchEvent(new Event('change', { bubbles: true }));
      
      // Also update the hidden input if it exists
      const hiddenCustomerInput = document.querySelector('input[name="customerId"]');
      if (hiddenCustomerInput) {
        hiddenCustomerInput.value = customerId;
      }
      
      // Close modal and reset form
      const modal = bootstrap.Modal.getInstance(document.getElementById('newCustomerModal'));
      modal.hide();
      form.reset();
      
      // Show success message
      const successAlert = document.createElement('div');
      successAlert.className = 'alert alert-success alert-dismissible fade show';
      successAlert.innerHTML = '<strong>Success!</strong> Customer "' + result.customer.name + '" created and selected.';
      successAlert.innerHTML += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
      document.querySelector('.container-fluid').insertBefore(successAlert, document.querySelector('.container-fluid').firstChild);
      
      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        successAlert.remove();
      }, 3000);
      
    } catch (error) {
      let errorMessage = 'Error creating customer. Please try again.';
      if (error.message) {
        errorMessage = error.message;
      }
      
      errorDiv.textContent = errorMessage;
      errorDiv.classList.remove('d-none');
      
      // Scroll to error message
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } finally {
      submitBtn.disabled = false;
      spinner.classList.add('d-none');
    }
    });
    
    return true;
  }
  
  // Setup customer modal handlers - will be called after modal HTML is loaded
  function setupCustomerModal() {
    // Reset customer modal form when closed and attach handler when modal opens
    const customerModal = document.getElementById('newCustomerModal');
    if (!customerModal) {
      console.error('Customer modal element not found!');
      return;
    }
    
    console.log('Customer modal element found, setting up event listeners');
    
    customerModal.addEventListener('hidden.bs.modal', function() {
      const form = document.getElementById('newCustomerForm');
      if (form) {
        form.reset();
      }
      const errorDiv = document.getElementById('customerFormError');
      if (errorDiv) {
        errorDiv.classList.add('d-none');
      }
    });

    // Close any open product dropdowns when customer modal opens and ensure handler is attached
    customerModal.addEventListener('show.bs.modal', function() {
      console.log('Customer modal opening, attaching handler...');
      // Close all product dropdowns
      document.querySelectorAll('.product-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
      
      // Small delay to ensure modal content is fully rendered
      setTimeout(() => {
        // Ensure form handler is attached
        const attached = attachCustomerFormHandler();
        if (!attached) {
          console.error('Failed to attach customer form handler when modal opened!');
          // Try one more time after a longer delay
          setTimeout(() => {
            const retry = attachCustomerFormHandler();
            if (!retry) {
              console.error('Failed to attach customer form handler after retry!');
            }
          }, 200);
        }
      }, 50);
    });
  }
  
  // Setup modal handlers after a short delay to ensure modal HTML is in DOM
  setTimeout(() => {
    setupCustomerModal();
  }, 100);

  // Convert items array to JSON before submit
  document.getElementById('jobForm').addEventListener('submit', function(e) {
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
      const productId = row.querySelector('.product-id-input').value;
      const quantity = row.querySelector('.quantity-input').value;
      const unitPrice = row.querySelector('.price-input').value;
      const isTaxable = row.querySelector('.taxable-checkbox').checked;

      // Validate that all fields are present and valid
      if (productId && 
          quantity && 
          !isNaN(parseFloat(quantity)) && 
          parseFloat(quantity) > 0 &&
          unitPrice && 
          !isNaN(parseFloat(unitPrice)) && 
          parseFloat(unitPrice) >= 0) {
        items.push({
          productId: productId.trim(),
          quantity: parseFloat(quantity),
          unitPrice: parseFloat(unitPrice),
          isTaxable: isTaxable.toString()
        });
      }
    });

    // Check if at least one item is present
    if (items.length === 0) {
      e.preventDefault();
      alert('Please add at least one product to the job.');
      return false;
    }

    // Remove all native form field names for items to prevent double submission
    document.querySelectorAll('.item-row input, .item-row select').forEach(field => {
      field.removeAttribute('name');
    });

    // Add hidden input with JSON
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'items';
    hiddenInput.value = JSON.stringify(items);
    this.appendChild(hiddenInput);
  });
</script>

<!-- New Customer Modal - Must be outside container for proper z-index stacking -->
<div class="modal fade" id="newCustomerModal" tabindex="-1" aria-labelledby="newCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newCustomerModalLabel">New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="newCustomerForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="customerName" class="form-label">Name *</label>
            <input type="text" class="form-control" id="customerName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="customerPhone" class="form-label">Phone</label>
            <input type="tel" class="form-control" id="customerPhone" name="phone">
          </div>
          <div class="mb-3">
            <label for="customerEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="customerEmail" name="email">
          </div>
          <div class="mb-3">
            <label for="customerAddress" class="form-label">Address</label>
            <textarea class="form-control" id="customerAddress" name="address" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="customerNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="customerNotes" name="notes" rows="3"></textarea>
          </div>
          <div id="customerFormError" class="alert alert-danger d-none" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span id="customerSubmitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Create & Select
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Setup customer modal handlers now that modal HTML is in DOM
  (function() {
    const customerModal = document.getElementById('newCustomerModal');
    if (!customerModal) {
      console.error('Customer modal element not found after page load!');
      return;
    }
    
    console.log('Customer modal element found, setting up event listeners');
    
    customerModal.addEventListener('hidden.bs.modal', function() {
      const form = document.getElementById('newCustomerForm');
      if (form) {
        form.reset();
      }
      const errorDiv = document.getElementById('customerFormError');
      if (errorDiv) {
        errorDiv.classList.add('d-none');
      }
    });

    // Close any open product dropdowns when customer modal opens and ensure handler is attached
    customerModal.addEventListener('show.bs.modal', function() {
      console.log('Customer modal opening, attaching handler...');
      // Close all product dropdowns
      document.querySelectorAll('.product-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
      
      // Small delay to ensure modal content is fully rendered
      setTimeout(() => {
        // Ensure form handler is attached - use the function from the main script
        if (typeof attachCustomerFormHandler === 'function') {
          const attached = attachCustomerFormHandler();
          if (!attached) {
            console.error('Failed to attach customer form handler when modal opened!');
            // Try one more time after a longer delay
            setTimeout(() => {
              const retry = attachCustomerFormHandler();
              if (!retry) {
                console.error('Failed to attach customer form handler after retry!');
              }
            }, 200);
          }
        } else {
          console.error('attachCustomerFormHandler function not found!');
        }
      }, 50);
    });
  })();
</script>

<!-- Calendar Modal -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calendarModalLabel">Job Calendar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="calendar-container">
          <div class="calendar-header mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <button type="button" class="btn btn-sm btn-outline-primary" id="calendarPrevMonth">
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <h5 class="mb-0" id="calendarMonthYear">Loading...</h5>
              <button type="button" class="btn btn-sm btn-outline-primary" id="calendarNextMonth">
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="calendar-wrapper">
            <table class="table table-bordered calendar-table">
              <thead>
                <tr>
                  <th class="text-center">Sun</th>
                  <th class="text-center">Mon</th>
                  <th class="text-center">Tue</th>
                  <th class="text-center">Wed</th>
                  <th class="text-center">Thu</th>
                  <th class="text-center">Fri</th>
                  <th class="text-center">Sat</th>
                </tr>
              </thead>
              <tbody id="calendarBody">
                <tr><td colspan="7" class="text-center">Loading calendar...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="calendar-events-list mt-3" id="calendarEventsList" style="max-height: 200px; overflow-y: auto;">
            <h6>Events for selected month:</h6>
            <div id="eventsListContent">Loading events...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  .calendar-container {
    min-height: 400px;
  }
  
  .calendar-table {
    width: 100%;
    table-layout: fixed;
  }
  
  .calendar-table td {
    height: 60px;
    vertical-align: top;
    padding: 4px;
    position: relative;
  }
  
  .calendar-table td.calendar-day {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .calendar-table td.calendar-day:hover {
    background-color: #f8f9fa;
  }
  
  .calendar-table td.other-month {
    color: #ccc;
    background-color: #f8f9fa;
  }
  
  .calendar-table td.today {
    background-color: #e7f3ff;
    font-weight: bold;
  }
  
  .calendar-table td.has-events {
    background-color: #fff3cd;
  }
  
  .calendar-day-number {
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  .calendar-event-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #0d6efd;
    display: inline-block;
    margin: 1px;
  }
  
  .calendar-event-count {
    font-size: 0.75rem;
    color: #0d6efd;
    font-weight: bold;
    margin-top: 2px;
  }
  
  .event-item {
    padding: 8px;
    margin-bottom: 8px;
    border-left: 3px solid #0d6efd;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  
  .event-item .event-date {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
  }
  
  .event-item .event-title {
    font-weight: 500;
    margin-top: 4px;
  }
  
  .event-item .event-details {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 4px;
  }
</style>

<script>
  // Calendar functionality
  (function() {
    let currentDate = new Date();
    let events = [];
    
    const monthNames = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    function updateCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update month/year display
      document.getElementById('calendarMonthYear').textContent = 
        monthNames[month] + ' ' + year;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Build calendar
      let calendarHTML = '';
      let date = 1;
      
      // Create weeks
      for (let i = 0; i < 6; i++) {
        calendarHTML += '<tr>';
        
        for (let j = 0; j < 7; j++) {
          if (i === 0 && j < startingDayOfWeek) {
            // Previous month days
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            const dayNum = prevMonthDays - startingDayOfWeek + j + 1;
            calendarHTML += `<td class="other-month text-muted">${dayNum}</td>`;
          } else if (date > daysInMonth) {
            // Next month days
            const dayNum = date - daysInMonth;
            calendarHTML += `<td class="other-month text-muted">${dayNum}</td>`;
            date++;
          } else {
            // Current month days
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
            const dayEvents = events.filter(e => e.start === dateStr);
            const today = new Date();
            const isToday = today.getFullYear() === year && 
                           today.getMonth() === month && 
                           today.getDate() === date;
            
            let cellClass = 'calendar-day';
            if (isToday) cellClass += ' today';
            if (dayEvents.length > 0) cellClass += ' has-events';
            
            calendarHTML += `<td class="${cellClass}" data-date="${dateStr}">`;
            calendarHTML += `<div class="calendar-day-number">${date}</div>`;
            
            if (dayEvents.length > 0) {
              if (dayEvents.length <= 3) {
                dayEvents.forEach(event => {
                  calendarHTML += `<div class="calendar-event-dot" title="${event.title}"></div>`;
                });
              } else {
                calendarHTML += `<div class="calendar-event-count">${dayEvents.length} events</div>`;
              }
            }
            
            calendarHTML += '</td>';
            date++;
          }
        }
        
        calendarHTML += '</tr>';
        
        // Stop if we've filled all days
        if (date > daysInMonth) break;
      }
      
      document.getElementById('calendarBody').innerHTML = calendarHTML;
      
      // Update events list
      updateEventsList();
      
      // Add click handlers to calendar days
      document.querySelectorAll('.calendar-day').forEach(cell => {
        cell.addEventListener('click', function() {
          const selectedDate = this.getAttribute('data-date');
          if (selectedDate) {
            // Update install date input if clicked
            const installDateInput = document.getElementById('installDate');
            if (installDateInput) {
              installDateInput.value = selectedDate;
            }
            
            // Highlight selected day
            document.querySelectorAll('.calendar-day').forEach(c => c.classList.remove('table-primary'));
            this.classList.add('table-primary');
          }
        });
      });
    }
    
    function updateEventsList() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Filter events for current month
      const monthEvents = events.filter(event => {
        if (!event.start) return false;
        const eventDate = new Date(event.start);
        return eventDate.getFullYear() === year && eventDate.getMonth() === month;
      });
      
      // Sort by date
      monthEvents.sort((a, b) => {
        return new Date(a.start) - new Date(b.start);
      });
      
      let eventsHTML = '';
      
      if (monthEvents.length === 0) {
        eventsHTML = '<p class="text-muted">No events scheduled for this month.</p>';
      } else {
        monthEvents.forEach(event => {
          const eventDate = new Date(event.start);
          const dateStr = eventDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
          
          eventsHTML += `
            <div class="event-item">
              <div class="event-date">${dateStr}</div>
              <div class="event-title">${event.title || 'Job'}</div>
              <div class="event-details">
                ${event.extendedProps?.customer || 'Unknown Customer'}
                ${event.extendedProps?.store ? ' - ' + event.extendedProps.store : ''}
                ${event.extendedProps?.installer ? ' | Installer: ' + event.extendedProps.installer : ''}
              </div>
            </div>
          `;
        });
      }
      
      document.getElementById('eventsListContent').innerHTML = eventsHTML;
    }
    
    function loadEvents() {
      fetch('/jobs/calendar/events')
        .then(response => response.json())
        .then(data => {
          events = data;
          updateCalendar();
        })
        .catch(error => {
          console.error('Error loading calendar events:', error);
          document.getElementById('eventsListContent').innerHTML = 
            '<p class="text-danger">Error loading events. Please try again.</p>';
        });
    }
    
    // Month navigation
    document.getElementById('calendarPrevMonth')?.addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      updateCalendar();
    });
    
    document.getElementById('calendarNextMonth')?.addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      updateCalendar();
    });
    
    // Load events when modal is shown
    const calendarModal = document.getElementById('calendarModal');
    if (calendarModal) {
      calendarModal.addEventListener('show.bs.modal', function() {
        currentDate = new Date(); // Reset to current month
        loadEvents();
      });
    }
  })();
</script>

<%- include('../partials/footer') %>

